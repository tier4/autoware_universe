name: create-sub-beta-branch

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: "Parent beta branch (e.g., beta/v4.2)"
        required: true
        type: string
      commit:
        description: "Specific commit SHA to branch from (defaults to latest commit of base_branch)"
        required: false
        type: string
      branch_name:
        description: "Full name of the new sub-branch (e.g., beta/v4.2-pilotone)"
        required: true
        type: string
      product_name:
        description: "Product identifier for labeling (e.g., pilotone)"
        required: true
        type: string
      target_repository:
        description: "Target repository for auto-sync (e.g., tier4/pilot-auto.x2)"
        required: false
        type: string
      target_branch:
        description: "Target branch in the target repository (e.g., beta/v4.2/pilotone)"
        required: false
        type: string

jobs:
  create-sub-beta-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          if [[ ! "${{ inputs.base_branch }}" =~ ^beta/ ]]; then
            echo "Error: base_branch must start with 'beta/'"
            exit 1
          fi
          if [[ -z "${{ inputs.branch_name }}" ]]; then
            echo "Error: branch_name is required"
            exit 1
          fi
          if [[ -z "${{ inputs.product_name }}" ]]; then
            echo "Error: product_name is required"
            exit 1
          fi

      - name: Generate token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      # Checkout the branch where this workflow lives to get the templates
      - name: Checkout workflow branch for templates
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - name: Cache workflow templates
        run: |
          # Save templates to a temporary location before switching branches
          mkdir -p /tmp/workflow-templates
          cp .github/workflow-templates/*.template /tmp/workflow-templates/
          echo "Cached workflow templates:"
          ls -la /tmp/workflow-templates/

      - name: Checkout base branch
        run: |
          git fetch origin ${{ inputs.base_branch }}
          git checkout ${{ inputs.base_branch }}
          echo "Checked out base branch: ${{ inputs.base_branch }}"

      - name: Set git config
        uses: autowarefoundation/autoware-github-actions/set-git-config@v1
        with:
          token: ${{ steps.generate-token.outputs.token }}

      - name: Get target commit
        id: get-commit
        run: |
          if [ -z "${{ inputs.commit }}" ]; then
            # Default to the latest commit of base_branch (current HEAD after checkout)
            COMMIT=$(git rev-parse HEAD)
            echo "Using latest commit from ${{ inputs.base_branch }}: $COMMIT"
          else
            COMMIT="${{ inputs.commit }}"
            # Verify the commit exists
            if ! git cat-file -e "$COMMIT^{commit}" 2>/dev/null; then
              echo "Error: Commit $COMMIT does not exist"
              exit 1
            fi
            echo "Using specified commit: $COMMIT"
          fi
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Check if branch already exists
        run: |
          if git ls-remote --exit-code --heads origin "${{ inputs.branch_name }}" >/dev/null 2>&1; then
            echo "Error: Branch ${{ inputs.branch_name }} already exists"
            exit 1
          fi
          echo "Branch ${{ inputs.branch_name }} does not exist, proceeding with creation"

      - name: Create child branch
        run: |
          git checkout -b "${{ inputs.branch_name }}" "${{ steps.get-commit.outputs.commit }}"
          echo "Created branch ${{ inputs.branch_name }} from commit ${{ steps.get-commit.outputs.commit }}"

      - name: Create branch meta file
        run: |
          mkdir -p .github
          cat > .github/branch-meta.yaml << EOF
          # Auto-generated by create-sub-beta-branch workflow
          # DO NOT EDIT - This file is read-only and serves as source of truth for child branch identity
          base_branch: ${{ inputs.base_branch }}
          commit: ${{ steps.get-commit.outputs.commit }}
          product_name: ${{ inputs.product_name }}
          created_at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF
          echo "Created .github/branch-meta.yaml"
          cat .github/branch-meta.yaml

      - name: Copy auto-add-label workflow template to child branch
        run: |
          mkdir -p .github/workflows
          cp /tmp/workflow-templates/auto-add-label.yaml.template \
             .github/workflows/auto-add-label.yaml
          echo "Copied auto-add-label.yaml to child branch"

      - name: Render auto-sync-pilot-auto workflow for child branch
        run: |
          mkdir -p .github/workflows
          TEMPLATE_FILE="/tmp/workflow-templates/auto-sync-pilot-auto.yaml.template"
          OUTPUT_FILE=".github/workflows/auto-sync-pilot-auto.yaml"

          if [ -f "$TEMPLATE_FILE" ]; then
            echo "Rendering auto-sync-pilot-auto.yaml template for child branch"

            # Read template file
            TEMPLATE_CONTENT=$(cat "$TEMPLATE_FILE")

            # Replace template variables
            # Using sed with different delimiters to avoid issues with slashes in branch names
            RENDERED_CONTENT=$(echo "$TEMPLATE_CONTENT" | \
              sed "s|{{SOURCE_BRANCH}}|${{ inputs.branch_name }}|g" | \
              sed "s|{{TARGET_REPOSITORY}}|${{ inputs.target_repository }}|g" | \
              sed "s|{{TARGET_BRANCH}}|${{ inputs.target_branch }}|g")

            # Write rendered content to output file
            echo "$RENDERED_CONTENT" > "$OUTPUT_FILE"

            echo "Created auto-sync-pilot-auto.yaml for child branch"
            echo "Source branch: ${{ inputs.branch_name }}"
            echo "Target repository: ${{ inputs.target_repository }}"
            echo "Target branch: ${{ inputs.target_branch }}"
          else
            echo "Warning: auto-sync-pilot-auto.yaml.template not found, skipping"
          fi

      - name: Commit and push child branch
        run: |
          git add .github/branch-meta.yaml .github/workflows/auto-add-label.yaml

          # Add the auto-sync workflow if it exists
          if [ -f ".github/workflows/auto-sync-pilot-auto.yaml" ]; then
            git add .github/workflows/auto-sync-pilot-auto.yaml
          fi

          git commit -m "chore: initialize child branch with meta file and workflows

          - Add .github/branch-meta.yaml with branch metadata
          - Add .github/workflows/auto-add-label.yaml for automatic PR labeling
          - Add .github/workflows/auto-sync-pilot-auto.yaml for syncing to ${{ inputs.target_repository }}
          - Base branch: ${{ inputs.base_branch }}
          - Product: ${{ inputs.product_name }}"
          git push origin "${{ inputs.branch_name }}"
          echo "Pushed child branch ${{ inputs.branch_name }} to remote"

      - name: Checkout base branch for updates
        run: |
          git checkout "${{ inputs.base_branch }}"
          git pull origin "${{ inputs.base_branch }}"

      - name: Check and create auto-update-child workflow if needed
        id: check-workflow
        run: |
          WORKFLOW_FILE=".github/workflows/auto-update-child.yaml"
          if [ -f "$WORKFLOW_FILE" ]; then
            echo "auto-update-child.yaml already exists in base branch"
            echo "workflow_exists=true" >> $GITHUB_OUTPUT
          else
            echo "auto-update-child.yaml does not exist, will create it"
            echo "workflow_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Copy auto-update-child workflow template to base branch
        if: steps.check-workflow.outputs.workflow_exists == 'false'
        run: |
          mkdir -p .github/workflows
          cp /tmp/workflow-templates/auto-update-child.yaml.template \
             .github/workflows/auto-update-child.yaml
          echo "Copied auto-update-child.yaml to base branch"

      - name: Install yq for YAML operations
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update children-branches.yaml
        run: |
          CHILDREN_FILE=".github/children-branches.yaml"
          CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [ ! -f "$CHILDREN_FILE" ]; then
            echo "Creating new children-branches.yaml"
            mkdir -p .github
            cat > "$CHILDREN_FILE" << EOF
          # Auto-generated by create-sub-beta-branch workflow
          # This file lists all child branches of this beta branch
          children:
            - branch: ${{ inputs.branch_name }}
              product_name: ${{ inputs.product_name }}
              created_at: $CREATED_AT
          EOF
          else
            echo "Updating existing children-branches.yaml"
            # Check if branch already exists in the file
            if yq ".children[] | select(.branch == \"${{ inputs.branch_name }}\")" "$CHILDREN_FILE" | grep -q .; then
              echo "Branch ${{ inputs.branch_name }} already registered in children-branches.yaml"
            else
              # Add new child entry
              yq -i ".children += [{\"branch\": \"${{ inputs.branch_name }}\", \"product_name\": \"${{ inputs.product_name }}\", \"created_at\": \"$CREATED_AT\"}]" "$CHILDREN_FILE"
              echo "Added ${{ inputs.branch_name }} to children-branches.yaml"
            fi
          fi

          echo "Current children-branches.yaml:"
          cat "$CHILDREN_FILE"

      - name: Create PR to base branch
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ steps.generate-token.outputs.token }}
          commit-message: |
            chore: register child branch ${{ inputs.branch_name }}

            - Add/update children-branches.yaml with new child branch
            - Create auto-update-child.yaml workflow if not exists
            - Child branch: ${{ inputs.branch_name }}
            - Product: ${{ inputs.product_name }}
          committer: GitHub <noreply@github.com>
          author: GitHub <noreply@github.com>
          signoff: false
          base: ${{ inputs.base_branch }}
          branch: register-child-branch/${{ inputs.branch_name }}
          delete-branch: true
          title: "chore: register child branch ${{ inputs.branch_name }}"
          body: |
            ## Summary
            This PR registers a new child branch for automatic cherry-picking.

            ## Details
            - **Child Branch:** `${{ inputs.branch_name }}`
            - **Base Branch:** `${{ inputs.base_branch }}`
            - **Product Name:** `${{ inputs.product_name }}`
            - **Created From Commit:** `${{ steps.get-commit.outputs.commit }}`

            ## Changes
            - Updates `.github/children-branches.yaml` to include the new child branch
            - Creates `.github/workflows/auto-update-child.yaml` if it doesn't exist

            ## What happens after merge
            - PRs merged into `${{ inputs.base_branch }}` will be automatically cherry-picked to `${{ inputs.branch_name }}`
            - Manual PRs to `${{ inputs.branch_name }}` will be automatically labeled with `${{ inputs.base_branch }}` and `${{ inputs.product_name }}`
          labels: |
            bot
            child-branch-registration
          draft: false

      - name: Output results
        run: |
          echo "=== Sub-Beta Branch Creation Complete ==="
          echo "Child Branch: ${{ inputs.branch_name }}"
          echo "Base Branch: ${{ inputs.base_branch }}"
          echo "Product Name: ${{ inputs.product_name }}"
          echo "Created From Commit: ${{ steps.get-commit.outputs.commit }}"
          echo ""
          echo "PR to register child branch: ${{ steps.create-pr.outputs.pull-request-url }}"
          echo ""
          echo "Next steps:"
          echo "1. Review and merge the PR to ${{ inputs.base_branch }}"
          echo "2. The child branch ${{ inputs.branch_name }} is ready for use"
          echo "3. PRs merged to ${{ inputs.base_branch }} will be auto-cherry-picked to ${{ inputs.branch_name }}"
          echo "4. Changes to ${{ inputs.branch_name }} will be auto-synced to ${{ inputs.target_repository }} branch ${{ inputs.target_branch }}"
