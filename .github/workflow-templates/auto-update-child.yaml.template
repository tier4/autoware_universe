name: Auto-update child branches

on:
  pull_request:
    types: [opened, reopened, closed, labeled]

jobs:
  auto-add-label:
    runs-on: ubuntu-latest
    # Add the label only when the PR is opened or reopened, and the PR is not created by a bot
    if: |
      (github.event.action == 'opened' || github.event.action == 'reopened') &&
      !contains(github.event.pull_request.user.login, 'bot')
    name: Auto-add cherry-pick label
    steps:
      - name: Generate token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - name: Create label if it doesn't exist
        uses: actions/github-script@v6
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'tag:enable-automatic-cherry-pick'
              });
              console.log('Label already exists');
            } catch (error) {
              if (error.status === 404) {
                console.log('Label does not exist. Creating it...');
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'tag:enable-automatic-cherry-pick',
                  color: '0E8A16',
                  description: 'Enable automatic cherry-pick for this PR'
                });
                console.log('Label created successfully');
              } else {
                console.log('Error checking label:', error);
                throw error;
              }
            }

      - name: Add label to PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            // Wait for 10 seconds to avoid conflict with the base pr labeler
            // Reference: https://github.com/actions/labeler/issues/763
            console.log('Waiting for 10 seconds...');
            await new Promise(resolve => setTimeout(resolve, 10000));
            console.log('Wait completed');

            await github.rest.issues.addLabels({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['tag:enable-automatic-cherry-pick']
            });
            console.log('Label added to PR');

  make-sure-label-is-present:
    uses: autowarefoundation/autoware-github-actions/.github/workflows/make-sure-label-is-present.yaml@v1
    if: github.event.action == 'closed' || github.event.action == 'labeled'
    with:
      label: tag:enable-automatic-cherry-pick

  read-children-branches:
    runs-on: ubuntu-latest
    needs: make-sure-label-is-present
    if: |
      github.event.pull_request.merged == true &&
      needs.make-sure-label-is-present.outputs.result == 'true' &&
      !contains(github.event.pull_request.title, 'üçí')
    outputs:
      children: ${{ steps.read.outputs.children }}
      has_children: ${{ steps.read.outputs.has_children }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Read children-branches.yaml
        id: read
        run: |
          CHILDREN_FILE=".github/children-branches.yaml"
          if [ ! -f "$CHILDREN_FILE" ]; then
            echo "No children-branches.yaml found"
            echo "children=[]" >> $GITHUB_OUTPUT
            echo "has_children=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Parse children branches and output as compact JSON array (single line)
          CHILDREN=$(yq -o=json -I=0 '.children | map(.branch)' "$CHILDREN_FILE")
          echo "Found children branches: $CHILDREN"
          echo "children=$CHILDREN" >> $GITHUB_OUTPUT

          # Check if there are any children
          COUNT=$(yq '.children | length' "$CHILDREN_FILE")
          if [ "$COUNT" -gt 0 ]; then
            echo "has_children=true" >> $GITHUB_OUTPUT
          else
            echo "has_children=false" >> $GITHUB_OUTPUT
          fi

  cherry-pick-to-children:
    needs: read-children-branches
    if: needs.read-children-branches.outputs.has_children == 'true'
    runs-on: ubuntu-latest
    name: Cherry-pick to child branches
    strategy:
      fail-fast: false
      matrix:
        child-branch: ${{ fromJson(needs.read-children-branches.outputs.children) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Generate token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - name: Cherry pick
        id: cherry-pick
        uses: tier4/action-auto-cherry-pick@v1.0.5
        with:
          target-branch: ${{ matrix.child-branch }}
          pr-title-suffix: üçí${{ matrix.child-branch }}
          pr-labels: bot,cherry-pick
          pr-creator-token: ${{ steps.generate-token.outputs.token }}

      - name: Get the output
        run: echo "The created PR number is ${{ steps.cherry-pick.outputs.pr-number }}"

      - name: Publish result to the pull request
        uses: actions/github-script@v6
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ü§ñ: The created PR number is #${{ steps.cherry-pick.outputs.pr-number }} for ${{ matrix.child-branch }}"
            })
