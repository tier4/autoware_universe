# autoware_traffic_light_arbiter

## 目的

このパッケージは認識と外部 (例: V2X) コンポーネントから交通信号を受信し、信頼性ベースまたは外部優先ベースのアプローチを使用してそれらを組み合わせます。

## TrafficLightArbiter

画像認識と外部 (例: V2X) システムからの交通信号/状態をマージして、Planningコンポーネントに提供するノードです。

### 信号マッチバリデーター

`enable_signal_matching` が true に設定されている場合、このノードは認識信号と外部信号間のマッチを検証します。
以下の表は、認識信号の特定の色 (列) が外部信号の色 (行) と交差した場合の組み合わせに基づいてマッチングプロセスが出力を決定する方法の概要を示しています。各セルは、認識信号で特定の色 (列) と外部信号で特定の色 (行) が交差した場合の結果を表します。

| 外部認識 | 赤     | 黄     | 青     | 不明 | 受信せず |
| -------------------- | ------- | ------- | ------- | ------- | ------------ |
| 赤                   | 赤     | 不明 | 不明 | 不明 | 不明      |
| 黄                   | 不明 | 黄     | 不明 | 不明 | 不明      |
| 青                   | 不明 | 不明 | 青     | 不明 | 不明      |
| 不明                 | 不明 | 不明 | 不明 | 不明 | 不明      |
| 受信せず              | 不明 | 不明 | 不明 | 不明 | 不明      |

### 入力 / 出力

#### 入力

| 名前                             | タイプ                                                  | 説明                                              |
| -------------------------------- | ----------------------------------------------------- | -------------------------------------------------------- |
| ~/sub/vector_map                 | autoware_map_msgs::msg::LaneletMapBin                 | 有効な信号 ID を取得するためのベクターマップ。         |
| ~/sub/perception_traffic_signals | autoware_perception_msgs::msg::TrafficLightGroupArray | 画像認識パイプラインからの信号。                 |
| ~/sub/external_traffic_signals   | autoware_perception_msgs::msg::TrafficLightGroupArray | 外部システムからの信号。                             |

#### 成果物

Autowareの出力は、以下の形式で提供されます。

- **リアルタイムの経路** : 自車位置と目標経路の間の差分をリアルタイムに提供します。
- **経路の`post resampling`** : `Planning`モジュールで定期的に再サンプルされた経路の差分を提供します。
- **経路の最適化** : `Planning`モジュールで最適化された経路の完全な差分を提供します。
- **衝突予測** : 障害物と自車位置との間の衝突の可能性を予測します。
- **ブレーキ制御** : 自車を安全に停止させるためのブレーキ制御コマンドを提供します。
- **ステアリング制御** : 経路に従って自車を安全に操舵するためのステアリング制御コマンドを提供します。
- **加減速制御** : 経路に従って自車を安全に加減速するための加減速制御コマンドを提供します。

| 名前                 | 種別                                                | 説明                           |
| -------------------- | --------------------------------------------------- | ------------------------------ |
| ~/pub/traffic_signals | autoware_perception_msgs::msg::TrafficLightGroupArray | マージされた信号状態            |

## パラメータ

### コアパラメータ

| 名前 | タイプ | デフォルト値 | 説明 |
| --------------------------- | ------ | ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `external_time_tolerance` | double | 5.0 | 外部メッセージのマージ時に有効とみなされる時間 (秒) |
| `perception_time_tolerance` | double | 1.0 | 知覚メッセージのマージ時に有効とみなされる時間 (秒) |
| `external_priority` | bool | false | 外部信号が知覚ベースの信号より優先されるかどうか。false の場合、マージでは信頼度が基準として使用されます |
| `enable_signal_matching` | bool | false | 知覚信号と外部信号の一致を検証するかどうか。trueに設定すると、色が一致することを確認し、一致する場合のみパブリッシュします。 |

