# acados_mpc - MPC solver using acados
# Requires acados installed (e.g. at /opt/acados via ansible-playbook autoware.dev_env.setup_acados)
# and ACADOS_SOURCE_DIR set (env or parent). Parent must find_package(acados) before add_subdirectory.

set(ACADOS_SOURCE_DIR "$ENV{ACADOS_SOURCE_DIR}")
if(NOT ACADOS_SOURCE_DIR)
  set(ACADOS_SOURCE_DIR "/opt/acados")
endif()

# Validate required acados components
foreach(_check "bin/t_renderer" ".venv/bin/python3" "interfaces/acados_template")
  if(NOT EXISTS "${ACADOS_SOURCE_DIR}/${_check}")
    message(FATAL_ERROR "${_check} not found in ${ACADOS_SOURCE_DIR}. "
      "Run: ansible-playbook autoware.dev_env.setup_acados --ask-become-pass (or set ACADOS_SOURCE_DIR)")
  endif()
endforeach()

# --- Code generation (Python â†’ C via t_renderer) ---
get_filename_component(PKG_SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/.." ABSOLUTE)
set(GENERATORS_DIR "${PKG_SOURCE_DIR}/generators")
set(MODEL "combined_longitudinal_lateral")
set(GEN_DIR "${GENERATORS_DIR}/c_generated_code")

set(GENERATED_MPC_FILES
  ${GEN_DIR}/acados_solver_${MODEL}.h
  ${GEN_DIR}/acados_solver_${MODEL}.c
  ${GEN_DIR}/acados_sim_solver_${MODEL}.h
  ${GEN_DIR}/acados_sim_solver_${MODEL}.c
  ${GEN_DIR}/${MODEL}_model/${MODEL}_expl_ode_fun.c
  ${GEN_DIR}/${MODEL}_model/${MODEL}_expl_vde_adj.c
  ${GEN_DIR}/${MODEL}_model/${MODEL}_expl_vde_forw.c
  ${GEN_DIR}/${MODEL}_model/${MODEL}_model.h
  ${GEN_DIR}/${MODEL}_constraints/${MODEL}_constraints.h
  ${GEN_DIR}/${MODEL}_constraints/${MODEL}_constr_h_fun.c
  ${GEN_DIR}/${MODEL}_constraints/${MODEL}_constr_h_fun_jac_uxt_zt.c
)
set_source_files_properties(${GENERATED_MPC_FILES} PROPERTIES GENERATED TRUE)

set(_template_path "${ACADOS_SOURCE_DIR}/interfaces/acados_template")
set(_env_vars
  "ACADOS_SOURCE_DIR=${ACADOS_SOURCE_DIR}"
  "PYTHONPATH=$ENV{PYTHONPATH}:${_template_path}"
)

add_custom_command(
  OUTPUT ${GENERATED_MPC_FILES}
  COMMAND ${CMAKE_COMMAND} -E env ${_env_vars}
  ${ACADOS_SOURCE_DIR}/.venv/bin/python3 mpc.py
  WORKING_DIRECTORY ${GENERATORS_DIR}
  DEPENDS ${GENERATORS_DIR}/mpc.py ${GENERATORS_DIR}/combined_longitudinal_lateral_model.py
  COMMENT "Generating MPC solver code..."
  VERBATIM
)

# --- acados_interface library ---
add_library(acados_interface SHARED
  acados_interface.cpp
  ${GENERATED_MPC_FILES}
)

target_include_directories(acados_interface PUBLIC
  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>
  $<INSTALL_INTERFACE:include>
  $<BUILD_INTERFACE:${GEN_DIR}>
  ${ACADOS_SOURCE_DIR}/include
  ${ACADOS_SOURCE_DIR}/include/acados
  ${ACADOS_SOURCE_DIR}/include/acados_c
  ${ACADOS_SOURCE_DIR}/include/blasfeo/include
  ${ACADOS_SOURCE_DIR}/include/hpipm/include
)

target_link_libraries(acados_interface PRIVATE acados)

# Suppress warnings on generated C code
if(CMAKE_C_COMPILER_ID STREQUAL "GNU" OR CMAKE_C_COMPILER_ID MATCHES "Clang")
  set_source_files_properties(${GENERATED_MPC_FILES} PROPERTIES
    COMPILE_OPTIONS "-Wno-all;-Wno-extra;-Wno-unused-function")
endif()
