## autoware_operation_mode_transition_manager

## 目的/ユースケース

このモジュールは、Autowareシステムのさまざまな動作モードを管理する役割を持ちます。利用可能なモードは次のとおりです。

- `Autonomous`: 車両が自動運転システムによって完全に制御されます
- `Local`: 車両がジョイスティックなどの物理的に接続された制御システムによって制御されます
- `Remote`: 車両がリモートコントローラーによって制御されます
- `Stop`: 車両が停止し、アクティブな制御システムはありません

また、各モードの遷移中に発生する「In Transition」状態もあります。この状態の間、新しいオペレーターへの移行はまだ完了しておらず、移行が完了するまで、以前のオペレーターが引き続きシステムの制御を担当します。急ブレーキや急ハンドルなど、一部のアクションは「In Transition」状態中に制限される場合があります。（これは「vehicle_cmd_gate」によって制限されます）

### 特徴

- インジケータコマンドに基づいて、「Autonomous」、「Local」、「Remote」、「Stop」間のモード遷移を行います。
- 各遷移が利用可能（安全かどうか）をチェックします。
- 「In Transition」モードで急激な動作制御を制限します（これは「vehicle_cmd_gate」機能を使用して行われます）。
- 遷移が完了しているかどうかを確認します。

- 「Autonomous」、「Local」、「Remote」、「Stop」モード間の遷移を、指示されたコマンドに基づいて実行します。
- 各遷移が安全に実行できるかどうかを判断します。
- 「In Transition」モードで特定の急激なモーション制御を制限します（「vehicle_cmd_gate」機能を使用）。
- 遷移が完了したことを確認します。

## 設計

「autoware_operation_mode_transition_manager」と他のノードとの関係のラフな設計を次に示します。

![transition_rough_structure](image/transition_rough_structure.drawio.svg)

詳細な構造を次に示します。

![transition_detailed_structure](image/transition_detailed_structure.drawio.svg)

ここで、「autoware_operation_mode_transition_manager」には、次のような複数のステート遷移があることがわかります。

- **AUTOWARE ENABLED <---> DISABLED**
  - **ENABLED**: 車両はAutowareによって制御されています。
  - **DISABLED**: 車両はAutowareの制御外であり、手動運転を想定しています。
- **AUTOWARE ENABLED <---> AUTO/LOCAL/REMOTE/NONE**
  - **AUTO**: 車両はAutowareによって制御され、計画/制御コンポーネントによって計算された自律制御指令を受けます。
  - **LOCAL**: 車両はAutowareによって制御され、ジョイスティックコントローラーなどのローカルに接続されたオペレーターが操作します。
  - **REMOTE**: 車両はAutowareによって制御され、リモートで接続されたオペレーターが操作します。
  - **NONE**: 車両はどのオペレーターによっても制御されていません。
- **IN TRANSITION <---> COMPLETED**
  - **IN TRANSITION**: 上記のモードが遷移処理中であり、以前のオペレーターが遷移が完了したことを確認する責任を負うことを想定しています。
  - **COMPLETED**: モード遷移が完了しました。

## 入出力/API

### 入力

モード遷移用：

- /system/operation_mode/change_autoware_control [`tier4_system_msgs/srv/ChangeAutowareControl`]: 動作モードを「Autonomous」に変更する
- /system/operation_mode/change_operation_mode [`tier4_system_msgs/srv/ChangeOperationMode`]: 動作モードを変更する

遷移の可用性/完了チェック用：

- /control/command/control_cmd [`autoware_control_msgs/msg/Control`]: 車両制御信号
- /localization/kinematic_state [`nav_msgs/msg/Odometry`]: 自車ステート
- /planning/scenario_planning/trajectory [`autoware_planning_msgs/msg/Trajectory`]: Planningトラジェトリ
- /vehicle/status/control_mode [`autoware_vehicle_msgs/msg/ControlModeReport`]: 車両制御モード（自律／手動）
- /control/vehicle_cmd_gate/operation_mode [`autoware_adapi_v1_msgs/msg/OperationModeState`]: `vehicle_cmd_gate`におけるオペレーションモード（削除予定）

後方互換性のために（削除予定）：

- /api/autoware/get/engage [`autoware_vehicle_msgs/msg/Engage`]
- /control/current_gate_mode [`tier4_control_msgs/msg/GateMode`]
- /control/external_cmd_selector/current_selector_mode [`tier4_control_msgs/msg/ExternalCommandSelectorMode`]

### 出力

- /system/operation_mode/state [`autoware_adapi_v1_msgs/msg/OperationModeState`]: 現在のオペレーションモードの通知用
- /control/autoware_operation_mode_transition_manager/debug_info [`autoware_operation_mode_transition_manager/msg/OperationModeTransitionManagerDebug`]: オペレーションモード遷移に関する詳細情報

- /control/gate_mode_cmd [`tier4_control_msgs/msg/GateMode`]: `vehicle_cmd_gate`ステートを変更して機能を使用する（削除予定）
- /autoware/engage [`autoware_vehicle_msgs/msg/Engage`]:

- /control/control_mode_request [`autoware_vehicle_msgs/srv/ControlModeCommand`]: 車両制御モード（自律／手動）を変更する
- /control/external_cmd_selector/select_external_command [`tier4_control_msgs/srv/ExternalCommandSelect`]:

## パラメータ

{{ json_to_markdown("control/autoware_operation_mode_transition_manager/schema/operation_mode_transition_manager.schema.json") }}

| 名前                               | 型       | 説明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | デフォルト値 |
| :--------------------------------- | :------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `transition_timeout`               | `double` | このタイムアウト時間を超えてステート遷移が完了しなかった場合、遷移の失敗とみなされます。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

`engage_acceptable_limits`関連パラメーターの場合：

| 名称                          | タイプ     | 説明                                                                                                                               | デフォルト値 |
| :---------------------------- | :------- | :-------------------------------------------------------------------------------------------------------------------------------- | :------------ |
| `allow_autonomous_in_stopped` | `bool`   | trueの場合、その他のチェックが失敗しても車両が停止しているときに自律運転への移行が可能です。                                  | true          |
| `dist_threshold`              | `double` | 軌跡と自車位置の距離がこの距離内にある場合、`Autonomous`への移行が可能です。                                             | 1.5           |
| `yaw_threshold`               | `double` | 軌跡と自車位置のヨー角がこのしきい値内にある場合、`Autonomous`への移行が可能です。                                         | 0.524         |
| `speed_upper_threshold`       | `double` | 制御コマンドと自車位置の速度偏差がこのしきい値内にある場合、`Autonomous`への移行が可能です。                              | 10.0          |
| `speed_lower_threshold`       | `double` | 制御コマンドと自車位置の速度偏差がこのしきい値内にある場合、`Autonomous`への移行が可能です。                              | -10.0         |
| `acc_threshold`               | `double` | 制御コマンドの加速度がこのしきい値よりも小である場合、`Autonomous`への移行が可能です。                                     | 1.5           |
| `lateral_acc_threshold`       | `double` | 制御コマンドの横加速度がこのしきい値よりも小である場合、`Autonomous`への移行が可能です。                                    | 1.0           |
| `lateral_acc_diff_threshold`  | `double` | 制御コマンドの横加速度偏差がこのしきい値よりも小である場合、`Autonomous`への移行が可能です。                            | 0.5           |

`stable_check` 関連のパラメータ:

| 名称                    | タイプ     | 説明                                                                                                                       | デフォルト値 |
| :---------------------- | :------- | :-------------------------------------------------------------------------------------------------------------------------------- | :------------ |
| `duration`              | `double` | この持続時間が安定状態を満たすことで遷移が完了する必要がある                                                              | 0.1           |
| `dist_threshold`        | `double` | 軌跡と自車位置の間の距離がこの距離内にある場合に `Autonomous` への遷移が完了する                                           | 1.5           |
| `yaw_threshold`         | `double` | 軌跡と自車位置の間のヨー角がこのしきい値内にある場合に `Autonomous` への遷移が完了する                                      | 0.262         |
| `speed_upper_threshold` | `double` | 制御コマンドと自車位置間の速度偏差がこのしきい値内にある場合に `Autonomous` への遷移が完了する                         | 2.0           |
| `speed_lower_threshold` | `double` | 制御コマンドと自車位置間の速度偏差がこのしきい値内にある場合に `Autonomous` への遷移が完了する                         | 2.0           |

## 各パラメータ設定におけるアクティブ制御チェックの動作

このマトリックスは、パラメータ設定の組み合わせに基づき、車両がアクティブ制御できるシナリオについて示します。

| `enable_engage_on_driving` | `check_engage_condition` | `allow_autonomous_in_stopped` | 自車走行が許可されるシナリオ                                 |
| :------------------------: | :----------------------: | :---------------------------: | :---------------------------------------------------------------- |
|             x              |            x             |               x               | 車両が停止している場合のみ                                 |
|             x              |            x             |               o               | 車両が停止している場合のみ                                 |
|             x              |            o             |               x               | 車両が停止しており、自動運転条件がすべて満たされている場合 |
|             x              |            o             |               o               | 車両が停止している場合のみ                                 |
|             o              |            x             |               x               | いつでも（注意：推奨されません）                               |
|             o              |            x             |               o               | いつでも（注意：推奨されません）                               |
|             o              |            o             |               x               | 自動運転条件がすべて満たされている場合、車輌の状況に関係なく |
|             o              |            o             |               o               | 自動運転条件がすべて満たされているか、車輌が停止している場合 |

## 今後の拡張 / 未実装部分

- バックワードコンパティブインタフェースの削除が必要。
- 強力な関連性があるため、このノードは `vehicle_cmd_gate` にマージされるべき。

