# 自動緊急ブレーキ (AEB)

## 目的 / 役割

`autonomous_emergency_braking`は、制御モジュールにより作成された予測パス上の障害物または制御モジュールから推定されたセンサ値との衝突を防ぐモジュールです。

### 前提

このモジュールには次の前提があります。

- 自車の予測パスは、センサから作成されたパス、または制御モジュールから作成されたパス、あるいはその両方から作成できます。

- 現在速度と角速度は自車のセンサから取得でき、障害物として点を使用します。

- AEBがターゲットにする障害物は、入力点群から取得できる2D点、または予測された自己フットプリントパスと予測されたオブジェクトの形状との交点から取得できます。

### IMUパス生成: ステアリングアングルvs IMUの角速度

現在、IMUベースのパスは、IMU自体から取得された角速度を使用して生成されます。角速度の代わりにステアリングアングルを使用できると提案されています。

両方のアプローチの利点と欠点は次のとおりです。

IMU角速度:

- (+)通常、高い精度を有する
- (-)車両振動がノイズを引き起こす可能性がある

ステアリングアングル:

- (+)ノイズが少ない
- (-)ステアリングオフセットや間違ったギア比がある可能性があり、Autowareのステアリングアングルと実際のステアリングが同じにならない可能性がある。

現時点では、AEBモジュールのパス作成プロセスにステアリングアングルを実装する予定はありません。

## 仕組み / アルゴリズム

AEBは、緊急停止信号を出力する前に次の手順を実行します。

1. 必要に応じてAEBを有効にする。

2. 自車の予測パスを生成する。

3. 入力点群および/または予測されたオブジェクトデータからターゲット障害物を入手する。

4. 最も近い障害物の速度を見積もる。

5. ターゲット障害物との衝突チェック。

6. `/diagnostics`に緊急停止信号を送信する。

以下に各セクションの詳細を示します。

### 1. 必要に応じてAEBを有効にする

AEBモジュールは、次の条件を満たす場合、有効になりません。

- 自車が自動運転状態ではない

- 自車が停止している場合（現在の速度が0.1m/sのしきい値未満）

### 2. 自車の予測経路の生成

#### 2.1 IMU パス生成の概要

AEB は、接続されたセンサーから取得した現在の速度と現在の角速度に基づいて、予測されたフットプリントパスを生成します。 `use_imu_path` が `false` の場合は、このステップをスキップすることに注意してください。この予測パスは次のように生成されます。

$$
x_{k+1} = x_k + v cos(\theta_k) dt \\
y_{k+1} = y_k + v sin(\theta_k) dt \\
\theta_{k+1} = \theta_k + \omega dt
$$

ここで $v$ と $\omega$ はそれぞれ現在の縦方向速度と角速度です。 $dt$ はユーザーが `imu_prediction_time_interval` パラメータで事前に定義できる時間間隔です。IMU のパスは、 `imu_prediction_time_horizon` パラメータで定義された予測時間 горизонт を考慮して生成されます。

#### 2.2 IMU パス生成における制約と対策

IMU パス生成は自車の現在の角速度のみを使用するため、MPC Planing ステアリングを無視すると、IMU パス形状はやや歪み、自車の現在の車線から飛び出して、不要な緊急停止を引き起こす可能性があります。この問題に対する 2 つの対策があります。

1. `max_generated_imu_path_length` パラメータを使用して制御する

   - パスの長さが設定値を超えると生成が停止します
   - 大きな `imu_prediction_time_horizon` を使用しないでください

2. 横方向の逸脱に基づいて制御する
   - `limit_imu_path_lat_dev` パラメータを "true" に設定します
   - `imu_path_lat_dev_threshold` を使用して逸脱しきい値を設定します
   - 横方向の逸脱がしきい値を超えるとパスの生成が停止します

#### 2.3 横方向逸脱制御の長所と短所

`limit_imu_path_lat_dev` パラメータで横方向逸脱の制限を設定する利点は、IMU 予測パスの変形が特定のしきい値を超えることを心配することなく、 `imu_prediction_time_horizon` と `max_generated_imu_path_length` を増やすことができることです。欠点は、自車の角速度が高い場合に IMU パスが短くなることで、このような場合、AEB モジュールは主に MPC パスに依存して衝突を防いだり軽減したりします。

自車が主に車線のcenterlineに沿って走行すると想定される場合、横方向逸脱しきい値パラメータ `imu_path_lat_dev_threshold` を 2 で割った平均車線幅以下に設定すると便利です。そうすれば、IMU 予測パスが現在の自車車線を逸脱する可能性が低くなり、自車が主に直線で走行しているときに正面衝突を防ぐために `imu_prediction_time_horizon` を増やすことが可能です。

横方向の逸脱は、現在の自車位置を基準にして測定され、予測された自車フットプリントの最も遠方の頂点から予測されたパスまでの距離を測定します。次の画像は、特定の自車位置の横方向逸脱の測定方法を示しています。

![measuring_lat_dev](./image/measuring-lat-dev-on-imu-path.drawio.svg)

#### 2.4 IMU パス生成アルゴリズム

##### 2.4.1 横方向逸脱チェックポイントの選択

次の条件に基づいて、横方向逸脱チェック用の車両の頂点を選択します。

- 前進 ($v > 0$)
  - 右折 ($\omega > 0$): 右前頂点
  - 左折 ($\omega < 0$): 左前頂点
- 後退 ($v < 0$)
  - 右折 ($\omega > 0$): 右後頂点
  - 左折 ($\omega < 0$): 左後頂点
- 直進 ($\omega = 0$): 前進/後退に応じて前部/後部の両方の頂点を確認します

##### 2.4.2 パス生成プロセス

各タイムステップで次のステップを実行します。

1. 状態の更新

   - 現在の速度 $v$ と角速度 $\omega$ に基づいて次の位置 $(x_{k+1}, y_{k+1})$ とヨー角 $\theta_{k+1}$ を計算します

## 2. 車両フットプリント生成

- 計算された位置に車両フットプリントを配置する
- チェックポイント座標を計算する

## 3. 側方逸脱計算

- 選択した頂点から経路までの側方逸脱を計算する
- 経路長と経過時間を更新する

## 4. 終了条件の評価

### 2.4.3 終了条件

経路生成は、次の条件のいずれかが満たされたときに終了します。

1. 基本終了条件（どちらも満たす必要があります）

   - 予測時間が `imu_prediction_time_horizon` を超える
   - かつ経路長が `min_generated_imu_path_length` を超える

2. 経路長終了条件

   - 経路長が `max_generated_imu_path_length` を超える

3. 側方逸脱終了条件（`limit_imu_path_lat_dev = true` の場合）

   - 選択した頂点の側方逸脱が `imu_path_lat_dev_threshold` を超える

### MPC 経路生成

`use_predicted_trajectory` パラメーターが true に設定されている場合、AEB モジュールは MPC から予測された経路をフットプリント経路生成のベースとして直接使用します。ある時間基準まで MPC によって生成された自車位置をコピーします。`mpc_prediction_time_horizon` パラメーターは、MPC 経路が自車の動きをどれだけ先まで予測するかを示します。IMU フットプリント経路と MPC フットプリント経路は同時に使用できます。

### 3. 対象障害物の取得

自車のフットプリント経路を生成した後、対象障害物が特定されます。対象障害物を見つける方法は 2 つあります。入力点群を使用する方法と、知覚モジュールから提供される予測オブジェクト情報を使用する方法です。

### 点群障害物フィルタリング

AEB モジュールは入力点群をフィルタリングして、自車が衝突する可能性のある対象障害物を見つけることができます。この方法は、`use_pointcloud_data` パラメーターが true に設定されている場合に有効にできます。点群障害物フィルタリングには、粗フィルタリング、クラスタリングによるノイズフィルタリング、および厳密フィルタリングの 3 つの主要な手順があります。

### 粗フィルタリング

粗フィルタリング手順では、単純なフィルタでターゲット障害物を選択します。自車の予測経路から一定の距離（デフォルトは自車幅の半分に `path_footprint_extra_margin` パラメーターと `expand_width` パラメーターを加えたもの）まで検索領域を作成して、その範囲内にない点群を無視します。粗フィルタリングの手順を以下に示します。

![rough_filtering](./image/obstacle_filtering_1.drawio.svg)

### クラスタリングと凸包によるノイズフィルタリング

AEB がノイズポイントを考慮するのを防ぐために、フィルタリングされた点群にユークリッドクラスタリングを実行します。クラスターを形成するには他の点に十分近くない点群内の点は破棄されます。さらに、クラスター内の各点を `cluster_minimum_height` パラメーターと比較し、クラスター内の点に `cluster_minimum_height` よりも大きい高さ/z 値がない場合、ポイントのクラスター全体が破棄されます。`cluster_tolerance`、`minimum_cluster_size`、`maximum_cluster_size` パラメーターを使用して、クラスタリングと無視されるオブジェクトのサイズを調整できます。AEB モジュールで使用されるクラスタリング方法の詳細については、PCL ライブラリのユークリッドクラスタリングに関する公式ドキュメントを参照してください: <https://pcl.readthedocs.io/projects/tutorials/en/master/cluster_extraction.html>。

さらに、検出された各クラスターの周囲に 2 次元の凸包が作成され、各包の頂点はクラスターの最も外側のポイントを表します。これらの頂点は、次の手順で確認されます。

### 厳密フィルタリング

ノイズフィルタリング後、モジュールは衝突の可能性が実際にあるかどうかを判断するために、フィルタリングされた障害物/包の頂点に対して衝突の幾何学的チェックを実行します。このチェックでは、自車は長方形として、点群障害物は点として表されます。衝突の可能性のある頂点のみが標的障害物としてラベル付けされます。

![rigorous_filtering](./image/obstacle_filtering_2.drawio.svg)

## 障害物ラベル付け
厳密なフィルタリング後、残した障害物はラベル付けされます。障害物は、自車位置の定義されたフットプリント（自車幅と`expand_width`パラメータを使用して作成）に収まる場合にのみ、衝突チェックの「ターゲット」ラベルが与えられます。緊急停止が発生するためには、少なくとも 1 つの障害物がターゲットとしてラベル付けされている必要があります。

![labeling](./image/labeling.drawio.svg)

#### ターゲット障害物を入手するための予測対象の使用
`use_predicted_object_data`パラメータが true に設定されている場合、AEB は知覚モジュールから提供される予測対象データを使用して、ターゲット障害物ポイントを取得できます。これを行うには、自車位置の予測されたフットプリントパス（自車幅と`expand_width`パラメータを使用して作成）と予測された対象のそれぞれを包む多角形または境界ボックスとの間の 2D 交点を求めます。交点がない場合は、すべてのポイントが破棄されます。

![predicted_object_and_path_intersection](./image/using-predicted-objects.drawio.svg)

### 最も近いターゲット障害物の検出
ポイントクラウドデータや予測対象データを使用して考えられるすべての障害物を識別した後、AEB モジュールは自車位置に最も近い点を衝突チェックの候補として選択します。「最も近い対象」とは、自車位置のフットプリント内にあり、その幅と`expand_width`パラメータによって決定され、IMU または MPC パスを基準として縦軸に沿って自車位置に最も近い障害物として定義されます。ターゲット障害物は ego パスの外側にある障害物よりも優先されます。これは、衝突チェックが車両の経路に基づいて最もリスクの高い対象に焦点を当てることを保証します。

ターゲット障害物が発見されない場合、AEB モジュールはパス外の他の近くの障害物を考慮します。そのような場合、衝突チェックはスキップされますが、速度を計算するために最も近い障害物の位置を記録します（ステップ 4）。予測対象データで取得した障害物はすべてターゲット障害物であるため、自車位置のフットプリントパス内にあり、速度を計算する必要はありません（知覚モジュールによってすでに計算されています）。このような障害物は、ステップ 4 から除外されます。

![closest_object](./image/closest-point.drawio.svg)

### 4. 障害物速度の推定
ターゲットポイントの速度の計算を開始するには、ポイントが速度計算領域に入る必要があります。これは、`speed_calculation_expansion_margin`パラメータに自車幅と`expand_width`パラメータを加えて定義されます。
運用環境によっては、このマージンにより、初期計算ステップ中の速度の誤算によって発生する不要な自動緊急ブレーキを減らすことができます。

![speed_calculation_expansion](./image/speed_calculation_expansion.drawio.svg)

最も近い障害物/ポイントの位置が決まると、AEB モジュールは以前に検出された対象の履歴を使用して、次の式を使用して最も近い対象の相対速度を推定します。

$$
d_{t} = t_{1} - t_{0}
$$

$$
d_{x} = norm(o_{x} - prev_{x})
$$

$$
v_{norm} = d_{x} / d_{t}
$$

ここで、$t_{1}$ と $t_{0}$ は、現在の最も近い対象を検出し、前のポイントクラウドフレームの最も近い対象を検出するために使用されるポイントクラウドのタイムスタンプであり、および $o_{x}$ と $prev_{x}$ はそれぞれそれらの対象の位置です。

![relative_speed](./image/object_relative_speed.drawio.svg)

最も近い障害物/ポイントが予測対象データを使用して取得される場合、$v_{norm}$ は x 軸と y 軸の予測対象の速度のノルムを直接計算することで計算されることに注意してください。

速度ベクトルは次に自車位置の予測経路と比較されて、縦方向の速度 $v_{obj}$ が取得されます。

$$
v_{obj} = v_{norm} * Cos(yaw_{diff}) + v_{ego}
$$

ここで、$yaw_{diff}$ は自車位置のパスと変位ベクトル $$v_{pos} = o_{pos} - prev_{pos} $$ のヨーの違いであり、$v_{ego}$ は自車位置の現在の速度であり、自車位置の移動によって引き起こされるポイントの移動を説明します。これらのすべての式は、z 軸（2D）を無視して実行されます。

対象の速度は、自車位置の現在の移動方向に対して計算されることに注意してください。対象が自車位置の移動とは逆の方向に移動する場合、対象の速度は負になり、次のステップで rss 距離が減少します。

### 5. RSS距離によるターゲット障害物との衝突チェック

5番目のステップで、AEBモジュールはRSS距離を使用して最も近いターゲット障害物との衝突をチェックします。衝突リスクを判断するためにRSS距離を使用するため、最も近いターゲットオブジェクトのみが評価されます。最も近いターゲットポイントが安全とみなされた場合、経路内の他のすべての潜在的な障害物も安全とみなされます。

RSS距離は次のように定式化されます。

$$
d = v_{ego}*t_{response} + v_{ego}^2/(2*a_{min}) -(sign(v_{obj})) * v_{obj}^2/(2*a_{obj_{min}}) + offset
$$

ここで、$v_{ego}$と$v_{obj}$は現在のエゴと障害物の速度、$a_{min}$と$a_{obj_{min}}$はエゴとオブジェクトの最小加速度（最大減速度）、$t_{response}$は減速を開始するためのエゴ車両の応答時間です。したがって、エゴ車両から障害物までの距離がこのRSS距離$d$より小さい場合、エゴ車両は緊急停止信号を送信します。

RSS距離の計算では、「ターゲット」として分類された障害物のみが考慮されます（ステップ3で定義）。これらの「ターゲット」障害物の中で、エゴ車両に最も近いものが計算に使用されます。「ターゲット」障害物が存在しない場合、つまり障害物がエゴ車両の予測経路（幅と拡張マージンで決定）に入らない場合、このステップはスキップされます。代わりに、最も近い障害物の位置が将来の速度計算（ステップ4）のために記録されます。このシナリオでは、緊急停止診断メッセージは生成されません。このプロセスは添付のダイアグラムで示されています。

![rss_check](./image/rss_check.drawio.svg)

### 6. `/diagnostics` に緊急停止信号を送信

前述のステップでAEBが点群障害物との衝突を検出すると、このステップで`/diagnostics`に緊急信号を送信します。緊急停止を有効にするには、必ずERRORレベルの緊急信号を送信する必要があることに注意してください。さらに、AEBユーザーは緊急レベルを保持するように設定ファイルを修正する必要があります。そうしないと、Autowareは緊急状態を保持しません。

## ユースケース

### 前方の車が急ブレーキ

前方車両が急ブレーキをかけて衝突をAEBモジュールが検出すると、AEBが作動する可能性があります。エゴ車両と前方車両間の距離が十分に大きく、エゴの緊急加速度値が十分に高い場合、急ブレーキをかける前方車両との衝突を回避または緩和できます。注: AEBがrss_distanceの計算に使用される加速度は、エゴが緊急ブレーキ中に使用される加速度とは必ずしも同じではありません。実際の車両で使用される加速度は、[MRM緊急停止のジャークと加速度の値](https://github.com/tier4/autoware_launch/blob/d1b2688f2788acab95bb9995d72efd7182e9006a/autoware_launch/config/system/mrm_emergency_stop_operator/mrm_emergency_stop_operator.param.yaml#L4)を変更することで調整できます。

![front vehicle collision prevention](./image/front_vehicle_collision.drawio.svg)

### 突如現れたオブジェクトの停止

オブジェクトが突然現れた場合、AEBは他のモジュールが時間内にオブジェクトを検出できなかった場合のエゴ車両の停止に関するフェイルセーフとして機能します。オブジェクトの急なカットインが予想される場合、AEBモジュールが`expand_width`パラメータを増やすことで、オブジェクトがエゴ車両の実際の経路に入る前に衝突を検出するのに役立つ場合があります。

![occluded object collision prevention](./image/occluded_space.drawio.svg)

### 後続オブジェクトとの衝突防止

エゴ車両が後進している場合も、AEBモジュールは衝突を防ぐことができます。

![backward driving](./image/backward-driving.drawio.svg)

### オドメトリが不正な場合の衝突防止（IMUパスのみ）

車両のオドメトリ情報が不正確な場合、MPCはエゴ車両の正しい経路を予測できない可能性があります。MPCの予測パスが間違っていると、計画モジュールでの衝突回避は意図したとおりに機能しません。ただし、AEBのIMUパスはMPCに依存せず、他のモジュールができない場合に衝突を予測できます。例として、MPCのパスが間違っていて、AEBのIMUパスだけが衝突を検出する仮説的なケースを示す図を参照してください。

![wrong mpc](./image/wrong-mpc.drawio.svg)

## パラメータ

| 名前 | 単位 | タイプ | 説明 | デフォルト値 |
|---|---|---|---|---|
| publish_debug_markers | [-] | ブール | デバッグマーカーをパブリッシュするフラグ | true |
| publish_debug_pointcloud | [-] | ブール | デバッグ用に使われる点群をパブリッシュするフラグ | false |
| use_predicted_trajectory | [-] | ブール | Planningモジュールからの予測パスを使用するフラグ | true |
| use_imu_path | [-] | ブール | センサーデータから生成された予測パスを使用するフラグ | true |
| use_object_velocity_calculation | [-] | ブール | オブジェクト速度計算を使用するフラグ。Falseに設定すると、オブジェクト速度は0 [m/s]に設定されます | true |
| check_autoware_state | [-] | ブール | Autowareの状態チェックを有効/無効にするフラグ。Falseに設定すると、自車がAUTONOMOUS状態にない場合でもAEBモジュールが実行されます | true |
| detection_range_min_height | [m] | double | 誤検出点群によるゴーストブレーキの回避に使用される、検出範囲の最小高さ | 0.0 |
| detection_range_max_height_margin | [m] | double | 誤検出点群によるゴーストブレーキの回避に使用される、検出範囲の最大高さのマージン。`detection_range_max_height = vehicle_height + detection_range_max_height_margin` | 0.0 |
| voxel_grid_x | [m] | double | ボクセルグリッドフィルタのx軸ダウンサンプリングパラメータ | 0.05 |
| voxel_grid_y | [m] | double | ボクセルグリッドフィルタのy軸ダウンサンプリングパラメータ | 0.05 |
| voxel_grid_z | [m] | double | ボクセルグリッドフィルタのz軸ダウンサンプリングパラメータ | 100000.0 |
| cluster_tolerance | [m] | double | 同じクラスターの一部とみなされる2つの点間の最大許容距離 | 0.15 |
| cluster_minimum_height | [m] | double | クラスター内に含まれる少なくとも1つのポイントがこの値より高くなければ、衝突対象の可能性のある候補セットにクラスターを組み込みません | 0.1 |
| minimum_cluster_size | [-] | int | 対象となる障害物とみなされるためには、クラスターに含まれる必要最低数のポイント数 | 10 |
| maximum_cluster_size | [-] | int | 対象となる障害物とみなされるためには、クラスターに含まれる最大数のポイント数 | 10000 |
| min_generated_imu_path_length | [m] | double | センサーによって生成された予測パスの最小距離 | 0.5 |
| max_generated_imu_path_length | [m] | double | センサーによって生成された予測パスの最大距離 | 10.0 |
| expand_width | [m] | double | 衝突チェック、パスクロッピング、速度計算における自車の拡大幅 | 0.1 |
| longitudinal_offset_margin | [m] | double | 衝突チェックのための縦方向オフセット距離 | 2.0 |
| t_response | [s] | double | 自車が前方車両の減速開始を検出するための応答時間 | 1.0 |
| a_ego_min | [m/ss] | double | 自車の最大減速度値 | -3.0 |
| a_obj_min | [m/ss] | double | 物体の最大減速度値 | -3.0 |
| imu_prediction_time_horizon | [s] | double | センサーによって生成された予測パスの時系列 | 1.5 |
| imu_prediction_time_interval | [s] | double | センサーによって生成された予測パスの時系列間隔 | 0.1 |
| mpc_prediction_time_horizon | [s] | double | mpcによって生成された予測パスの時系列 | 1.5 |
| mpc_prediction_time_interval | [s] | double | mpcによって生成された予測パスの時系列間隔 | 0.1 |
| aeb_hz | [-] | double | AEBが1秒間に動作する周波数 | 10 |
| speed_calculation_expansion_margin | [m] | double | 最も近いオブジェクトの速度を計算するときに使用される自車フットプリントの拡大幅 | 0.7 |
| path_footprint_extra_margin | [m] | double | AEB入力点群のクロッピングに使用される自車フットプリントを拡大するこのパラメータ | 1.0 |

## 制限

- 衝突検出後の停止に必要な距離は、自車速度と減速性能に依存します。衝突を回避するには、検出距離を延ばし、減速率を上げる必要があります。ただし、不要なアクティベーションの数も増える可能性があるため、トレードオフが生じます。したがって、このモジュールにどのような役割を持たせるべきかを検討し、それに応じてパラメータを調整することが不可欠です。

- AEBは、地面に近い障害物には反応できない可能性があります。これは、点群に適用される前処理方法のパフォーマンスに依存します。

- センサーから得られる縦加速度情報は、ノイズの量が多いため使用されていません。

- センサーデータから作成される予測経路の精度は、自車に搭載されたセンサーの精度に依存します。

![aeb_range](./image/range.drawio.svg)

