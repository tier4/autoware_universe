# プランニングバリデータ

`autoware_planning_validator` は軌跡を公開する前にその有効性をチェックするモジュールです。バリデーションのステータスは `/diagnostics` と `/validation_status` トピックで確認できます。無効な軌跡が検出された場合、`autoware_planning_validator` は選択されたオプションに従って軌跡を処理します: "0. 軌跡をそのまま公開する", "1. 軌跡の公開を停止する", "2. 最後にバリデーションされた軌跡を公開する"。

![autoware_planning_validator](./image/planning_validator.drawio.svg)

## 対応機能

軌跡のバリデーションで以下のような機能に対応しており、閾値をパラメータによって設定できます:

- **無効なフィールド**: Inf、Nan など
- **軌跡ポイントの間隔**: 軌跡ポイント間の距離が大きすぎる場合は無効
- **曲率**: 与えられた車両運動学的に実現不可能な鋭いターンを含む場合は無効
- **相対角**: 軌跡ポイントのシーケンスでヨー角が急激に変化する場合は無効
- **横加速度**: 期待される横加速度/減速度が大きすぎる場合は無効
- **縦加速度/減速度**: 軌跡ポイントにおける加速度/減速度が大きすぎる場合は無効
- **操舵角**: 軌跡の曲率から推定される期待される操舵値が大きすぎる場合は無効
- **操舵角速度**: 期待される操舵速度値が大きすぎる場合に無効
- **速度偏差**: プランニング速度がエゴ速度からかけ離れている場合に無効
- **距離偏差**: エゴが軌跡から離れすぎている場合に無効
- **縦距離偏差**: 軌跡がエゴから縦方向に離れすぎている場合に無効
- **前方軌跡長**: 与えられた減速度内で停止するために軌跡の長さが十分でない場合に無効

以下の機能は実装予定です。

- **(TODO) TTC 計算**: 期待される衝突時間 (TTC) が軌跡上で短すぎると無効

## 入/出力

### 入

`autoware_planning_validator` は以下の入力を受け取ります:

| 名前                 | タイプ                              | 説明                                    |
| -------------------- | --------------------------------- | ---------------------------------------------- |
| `~/input/kinematics` | nav_msgs/Odometry                 | 自車位置および速度                            |
| `~/input/trajectory` | autoware_planning_msgs/Trajectory | このノードで検証するターゲットの軌跡 |

### 出力

以下の出力を生成します。

| 名前 | 型 | 説明 |
|---|---|---|
| `~/output/trajectory` | autoware_planning_msgs/Trajectory | 妥当な軌跡 |
| `~/output/validation_status` | planning_validator/PlanningValidatorStatus | 軌跡が有効/無効である理由を伝える validator のステータス |
| `/diagnostics` | diagnostic_msgs/DiagnosticStatus | エラーを報告する診断 |

## パラメータ

`autoware_planning_validator` に対して以下のパラメータを設定することができます。

### システムパラメータ

| Name                               | Type | Description                                                                                                                                                                                                                                    | Default value |
| :--------------------------------- | :--- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------ |
| `invalid_trajectory_handling_type` | int  | 無効なトラекトリ検出時の動作を設定します。<br>0: 無効な場合でもトラекトリを公開する、<br>1: トラекトリの公開を停止する、<br>2: 最後に検証されたトラекトリを公開する | 0             |
| `publish_diag`                     | bool | 無効なトラекトリの連続数がこのしきい値を超えると、DiagはERRORに設定されます。(例:しきい値=1の場合、トラекトリが無効であっても、次のトラекトリが有効な場合、DiagはERRORになりません。) | true          |
| `diag_error_count_threshold`       | int  | trueの場合、診断メッセージが公開されます。 | true          |
| `display_on_terminal`              | bool | エラーメッセージを端末に表示します。 | true          |

### アルゴリズムパラメータ

#### しきい値

次のしきい値を超えた場合は、入力された軌跡は無効と検出されます。

| 名称                                         | 型                  | 説明                                                                                                                               | デフォルト値 |
| :------------------------------------------- | :------------------ | :---------------------------------------------------------------------------------------------------------------------------------- | :------------ |
| `thresholds.interval`                        | 数値 | 2つの近接した軌道ポイント間の距離の無効閾値 [m]                                                                             | 100.0         |
| `thresholds.relative_angle`                  | 数値 | 2つの近接した軌道ポイント間の相対角度の無効閾値 [rad]                                                                     | 2.0           |
| `thresholds.curvature`                       | 数値 | 各軌道ポイントにおける曲率の無効閾値 [1/m]                                                                                   | 1.0           |
| `thresholds.lateral_acc`                     | 数値 | 各軌道ポイントにおける横加速度の無効閾値 [m/ss]                                                                           | 9.8           |
| `thresholds.longitudinal_max_acc`            | 数値 | 各軌道ポイントにおける最大の縦加速度の無効閾値 [m/ss]                                                                      | 9.8           |
| `thresholds.longitudinal_min_acc`            | 数値 | 各軌道ポイントにおける最小の縦減速度の無効閾値 [m/ss]                                                                      | -9.8          |
| `thresholds.steering`                        | 数値 | 各軌道ポイントにおける操舵角の無効閾値 [rad]                                                                             | 1.414         |
| `thresholds.steering_rate`                   | 数値 | 各軌道ポイントにおける操舵角速度の無効閾値 [rad/s]                                                                       | 10.0          |
| `thresholds.velocity_deviation`              | 数値 | 自車速度と自車位置から最も近い軌道ポイント間の速度偏差の無効閾値 [m/s]                                                    | 100.0         |
| `thresholds.distance_deviation`              | 数値 | 自車位置と自車位置から最も近い軌道ポイント間の距離偏差の無効閾値 [m]                                                         | 100.0         |
| `parameters.longitudinal_distance_deviation` | 数値 | 自車位置と軌道間の縦距離偏差の無効閾値 [m]                                                                                      | 2.0           |

#### パラメータ

しきい値の計算に使用するパラメータなど。

| `parameters.forward_trajectory_length_acceleration` | double | この値は必要な軌道長を計算するために使用されます。 | -5.0 |
| `parameters.forward_trajectory_length_margin` | double | 自車が軌道の終端点をわずかに超えてもエラーが発生しないよう、必要な軌道長のマージン。 | 2.0 |

