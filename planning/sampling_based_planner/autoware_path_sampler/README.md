# パスサンプラー

## 目的

このパッケージは、サンプリングベースのプランニングを使用して走行可能な経路を生成するノードを実装しています。

## 機能

このパッケージは次のことが可能です。

- 経路を滑らかにする
- 経路を走行可能な領域内に保持する
- 静的障害物を回避する
- 有効な経路が生成できない場合は停止する

速度は入力パスからそのまま引き継がれます。

## 入出力

### 入力

| 名称 | タイプ | 説明 |
|---|---|---|
| `~/input/path` | `autoware_planning_msgs/msg/Path` | 基準パスと対応する走行可能領域 |
| `~/input/odometry` | `nav_msgs/msg/Odometry` | 自車位置 |
| `~/input/objects` | `autoware_perception_msgs/msg/PredictedObjects` | 避けるオブジェクト |

### 出力

[Autoware.Auto](https://github.com/autowarefoundation/autoware.auto)

Autoware.Autoは、自動運転モビリティ向けに設計されたオープンソースソフトウェア開発キット（SDK）です。このSDKは、あらゆる種類のモビリティ（車、トラック、バスなど）に搭載できるように設計されています。このドキュメントは、Autoware.Autoのサブシステムである**Planning**コンポーネントについて説明します。

**Planning**コンポーネントは、以下のタスクを担当します。

* 自車位置から目的地までの安全で実行可能な経路を生成する
* 経路に従って車両を誘導する制御信号を生成する

**Planning**コンポーネントは、以下を含む複数のモジュールで構成されています。

* **global planner**: グローバル経路を生成する
* **local planner**: ロカル経路を生成する
* **behavior planner**: 車両の挙動を計画する
* **decision maker**: 車両の意思決定を行う
* **motion planner**: 車両の動きを計画する

これらのモジュールは、センサーからの入力に基づいて、安全で実行可能な経路を生成するために協調して動作します。

**Planning**コンポーネントは、自己回帰移動平均（ARMA）アルゴリズムを使用して経路を再サンプリングします。これにより、経路がセンサーから得られる最新のデータと整合するように維持されます。

*post resampling*、経路は障害物や他の車両などの障害物を避けるために最適化されます。これにより、車両が安全に目的地に到達できるようになります。

**Planning**コンポーネントは、以下のインターフェイスを使用して他のAutoware.Autoサブシステムと通信します。

* **perception**: センサーからの入力を提供する
* **control**: 制御信号を送信する
* **localization**: 自車位置を提供する

| 名前                                   | 型                                                                  | 説明                                                                                       |
| ---------------------------------------- | --------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- |
| `~/output/trajectory`                     | autoware_planning_msgs/msg/Trajectory                               | 走行可能で衝突のない生成されたトラジェクトリ                                                   |

## アルゴリズム

サンプリングベースのプランニングは、3 つの連続したステップに分けられます。

1. サンプリング: 候補の軌道が生成されます。
2. 剪定: 無効な候補が破棄されます。
3. 選択: 残った有効な候補の中で最良のものが選択されます。

### サンプリング

候補の軌道は、現在の自車状態とターゲット状態に基づいて生成されます。
現在、2 つのサンプリングアルゴリズムが実装されています。ベジエ曲線を使用したサンプリングと、フレネフレーム内の多項式を使用したサンプリングです。

### 剪定

各候補の軌道の有効性は、一連のハード制約を使用してチェックされます。

- 衝突: 静止障害物との衝突を回避します。
- 曲率: 滑らかな曲率を確保します。
- 走行可能領域: 軌道が走行可能領域内にあることを確認します。

### 選択

有効な候補の軌道の中から、一連のソフト制約（つまり、目的関数）を使用して _ベスト_ な軌道が決定されます。

- 曲率: より滑らかな軌道を選択
- 長さ: より長い軌道を選択
- 側方偏差: 参照経路に近い軌道を選択

各ソフト制約には、プリファレンスの調整を可能にする重みが関連付けられています。

## 制限事項

フレネフレーム内の多項式で生成される候補の品質は、参照経路に大きく依存します。
参照経路が滑らかでないと、生成される候補は走行不可能になる可能性があります。

有効な軌道が見つからない場合は、現在、軌道が突然停止する結果になります。

## `autoware_path_optimizer` との比較

`autoware_path_optimizer` は最適化ベースのアプローチを使用し、数学的問題の最適解を見つけます（存在する場合）。
問題の中間的な数学的表現により、解が見つからない場合に問題を特定するのが難しいことがよくあります。

比較すると、サンプリングベースのアプローチは最適解を保証できませんが、はるかに単純です。これにより、デバッグと調整が容易になります。

## パラメータの調整方法

サンプリングベースのプランナーは、軌道の安定した品質と計算時間の間で主にトレードオフを提供します。
良好な軌道の発見を保証するには、多くの候補を生成する必要があり、これにより計算時間が線形に増加します。

TODO

### 狭い道路での走行性

### 計算時間

### ロバスト性

### その他のオプション

## デバッグ方法

TODO

