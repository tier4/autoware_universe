# Map Conversion Evaluation Tooling

This directory contains Python tooling to evaluate map preprocessing fidelity.

## Dependencies

- Python 3 with: `numpy`, `matplotlib`
- `jinja2` (for HTML dashboard rendering): `pip install jinja2`

- `compare_maps.py`: compares exported internal map JSON with reference map JSON

## Inputs

Expected JSON files are generated by `map_exporter`:

- `internal_map.json`: from `convert_to_internal_lanelet_map()`
- `reference.json`: reference map (raw filtered geometry or internal baseline)

## Metric design (no Python interpolation)

The evaluator intentionally does **not** resample or interpolate in Python.
It compares geometries using direct point-to-segment / point-to-boundary distances.

For a polyline pair A and B:

- A -> B: each point in A to nearest segment of B
- B -> A: each point in B to nearest segment of A
- symmetric metrics combine both directions

## Metrics

### Lane segments

- count consistency and unmatched IDs
- centerline and boundary symmetric Chamfer-like and Hausdorff-like metrics
- length relative error
- heading difference (deg)
- speed limit absolute error
- attribute agreement rate (`left_line_type`, `right_line_type`, `turn_direction`, `traffic_light_id`)
- pass rate for `centerline_symmetric_hausdorff_like < 0.2 m` (key metric)
- explicit lane ID mismatch report

### Polygons (`intersection_area`)

- count consistency
- symmetric Hausdorff-like distance
- symmetric Chamfer-like distance
- absolute and relative area error
- centroid offset

### Line strings (`stop_line`)

- count consistency
- endpoint error (orientation-agnostic)
- length error
- symmetric Hausdorff-like distance
- symmetric Chamfer-like distance
- orientation error (deg)

## Outputs

`compare_maps.py` writes:

- `metrics_summary.json`
- `lane_id_mismatch_report.json`
- `metrics_summary.csv`
- `entity_metrics.csv`
- `overlay_and_error_plots.png`
- `interactive_overlay.html` (Leaflet-based dashboard with layer tabs; unless `--skip_html`)
- `worst_cases/` per-entity debug JSON for top-K worst lanes, line strings, and polygons (by symmetric Hausdorff)

## Usage

### One-shot export + evaluate (recommended)

```bash
python3 tool/map_eval/compare_maps.py export-eval \
  --map_path /path/to/lanelet2_map.osm \
  --out_dir /tmp/map_eval \
  --output_prefix run1 \
  --max_match_distance 5.0 \
  --top_k_debug 20
```

### Evaluate existing JSON files

```bash
python3 tool/map_eval/compare_maps.py eval-only \
  --internal_map /tmp/internal_map.json \
  --reference_map /tmp/reference.json \
  --out_dir /tmp/map_eval \
  --max_match_distance 5.0 \
  --top_k_debug 20
```

### Run exporter directly (ROS parameter style)

```bash
ros2 run autoware_diffusion_planner map_exporter --ros-args \
  -p map_path:=/path/to/lanelet2_map.osm \
  -p internal_out:=/tmp/internal_map.json \
  -p reference_out:=/tmp/reference.json
```
