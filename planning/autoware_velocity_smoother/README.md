# Velocity Smoother

## 目的

`autoware_velocity_smoother`は、基準経路上の目標速度プロフィールを出力します。
このモジュールは速度、加速度、ジャークの制約内で速度プロフィールを計画し、速度の最大化と乗り心地の両方を向上します。加速とジャークの制約は速度プロフィールの滑らかさを意味するため、このモジュールを`autoware_velocity_smoother`と呼びます。

## 内部動作/アルゴリズム

### フローチャート

![motion_velocity_smoother_flow](./media/motion_velocity_smoother_flow.drawio.svg)

#### 経路の抽出

車両の後輪車軸中心に最も近い参考経路上の点に対して、`extract_behind_dist`の背後と`extract_ahead_dist`の前方の間の参考経路を抽出します。

#### 外部速度制限の適用

`autoware_velocity_smoother`の外部から入力された速度制限を適用します。
外部速度制限は、マップと参考経路にすでに設定されている速度制限とは異なることに注意してください。
外部速度は、パラメータとして設定した減速度とジャーク制約で速度制限に到達できる位置に適用されます。

#### 停止接近速度の適用

停止点付近の速度制限を適用します。
この機能は、障害物に接近したり、停止の精度を向上させたりするために使用されます。

#### 横加速度制限の適用

カーブで減速するための速度制限を適用します。
参考経路の曲率と最大横加速度`max_lateral_accel`から速度制限を計算します。速度制限は`min_curve_velocity`を下回らないように設定されます。

注: `nominal.jerk`を超える速度制限は適用されません。つまり、目の前に急カーブが計画されていても減速は行われません。

#### ステアリング速度制限の適用

経路ポイントの目標ステアリング角を計算し、ステアリング速度制限を適用します。 (`steering_angle_rate` > `max_steering_angle_rate`)の場合、経路ポイントの速度を許容可能な速度まで下げます。

#### 経路の再サンプリング

指定された時間間隔で基準経路上の点をリサンプリングします。
経路長の範囲は`min_trajectory_length`と`max_trajectory_length`の間に設定され、2点間の距離は`min_trajectory_interval_distance`より長くなります。
現在の速度で`resample_time`の間に移動する距離まで密にサンプリングし、その後は疎らにサンプリングします。速度に応じてサンプリングすることで、低速では細かく、高速では粗くサンプリングするため、計算負荷と精度が両立します。

#### 初期状態の計算

速度計画のための初期値を計算します。
次の表に示すように、状況に応じて初期値が計算されます。

| 状況                                                   | 初期速度       | 初期加速度   |
| -------------------------------------------------------- | ------------------ | ---------------------- |
| 初期計算                                                 | 自車速度           | 0.0                    |
| エンゲージ                                                 | `engage_velocity`      | `engage_acceleration`  |
| 計画速度と自車速度の乖離                               | 自車速度           | 直前の計画値 |
| 通常                                                       | 直前の計画値 | 直前の計画値 |

#### Smooth velocity

速度を計画します。
速度計画のアルゴリズムは、'JerkFiltered'、'L2'、'Linf' から選択され、ローンチファイルに設定されます。
これらのアルゴリズムでは、最適化のソルバーとして OSQP[1] を使用します。

##### JerkFiltered

速度の2乗のマイナスと、速度制限、加速度制限、ジャーク制限の違反の2乗の和を最小化します。

##### L2

速度の2乗のマイナス、擬似的なジャーク[2]の2乗、速度制限と加速度制限の違反の2乗の和を最小化します。

##### Linf

速度の2乗のマイナス、擬似的なジャーク[2]の絶対値の最大値、速度制限と加速度制限の違反の2乗の和を最小化します。

#### Post process

計画された速度のポストプロセスを実行します。

- 停止地点の前の速度をゼロに設定
- `max_velocity` という名前の構成に与えられた最大速度を設定
- 自車位置の後ろの速度を設定
- 軌道の再サンプリング（'post resampling'）
- デバッグデータを出力

最適化後、最適化された軌跡を次のノードに渡す前に「'post resampling'」と呼ばれる再サンプリングを実行します。最適化に必要なパス間隔が次のモジュールのパス間隔と異なる場合があるため、「'post resampling'」はこのギャップを埋めるのに役立ちます。したがって、「'post resampling'」では、パラメータを決定するために、次のモジュールのパス仕様を確認する必要があります。最初の再サンプリング時に最適化アルゴリズムの計算負荷が高く、パスの間隔が次のモジュールのパス仕様よりも疎である場合、「'post resampling'」は軌道を密に再サンプリングします。一方で、最適化アルゴリズムの計算負荷が小さく、1回目の再サンプリング時にパスの間隔が次のモジュールのパス仕様よりも密である場合、パスは次のモジュールの仕様に従ってまばらに再サンプリングされます。

## 入出力

### 入力

| 名前                                     | タイプ                                | 説明                                       |
| ------------------------------------------ | ----------------------------------- | ----------------------------------------- |
| `~/input/trajectory`                       | `autoware_planning_msgs/Trajectory` | 参照軌道                                   |
| `/planning/scenario_planning/max_velocity` | `std_msgs/Float32`                  | 外部速度制限 [m/s]                         |
| `/localization/kinematic_state`            | `nav_msgs/Odometry`                 | 自車位置                                   |
| `/tf`                                      | `tf2_msgs/TFMessage`                | TF                                        |
| `/tf_static`                               | `tf2_msgs/TFMessage`                | TF (静止)                                  |

### 出力
```
**はじめに**

このドキュメントは、Autoware プラットフォームの動的計画コンポーネントの概要を提供します。動的計画コンポーネントは、Perception (知覚) モジュールから受け取ったオブジェクトに関する情報を使用して、周辺環境内の車両の安全かつ効率的な移動を計画します。

**コンポーネントの概要**

動的計画コンポーネントは、以下のサブコンポーネントで構成されています。

* **TrajectoryGenerator (軌跡生成器):** 現在の速度と目標速度を使用して、車両の動作空間内の安全かつ実行可能な軌跡を生成します。
* **PathPlanner (経路計画器):** 周辺環境の地図情報を使用して、軌跡を実行可能な経路に変換します。
* **MotionPlanner (運動計画器):** 経路を、車両の運動学的な制約に従った詳細な制御コマンドに変換します。
* **ObstaclePredictor (障害物予測器):** 知覚モジュールから提供された予測を使用して、周囲のオブジェクトの将来の動きを予測します。

**ワークフロー**

動的計画コンポーネントのワークフローは次のとおりです。

1. Perception モジュールが周囲のオブジェクトに関する情報を提供します。
2. ObstaclePredictor が、提供された情報を基に周囲のオブジェクトの将来の動きを予測します。
3. TrajectoryGenerator が、自車位置、速度、目標速度などの情報を使用して、車両の動作空間内の安全で実行可能な軌跡を生成します。
4. PathPlanner が、地図情報を使用して軌跡を実行可能な経路に変換します。
5. MotionPlanner が、経路を車両の運動学的な制約に従った詳細な制御コマンドに変換します。

**'post resampling`の考慮事項**

`post resampling` 手法を使用する場合、動的計画コンポーネントは、パーティクルフィルタの出力を考慮に入れて予測を行います。このアプローチにより、動的計画コンポーネントは、環境内の不確実性をより適切に処理できます。

**結論**

動的計画コンポーネントは、Autoware プラットフォームの重要な部分です。車両の周囲環境を認識し、その中で安全かつ効率的に移動するための計画を立てます。このコンポーネントは、自己運転車の開発にとって不可欠です。
```

| 名称                                           | タイプ                                  | 説明                                                                                               |
| ---------------------------------------------- | --------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| `~/output/trajectory`                          | `autoware_planning_msgs/Trajectory`   | 変更された軌跡                                                                                        |
| `/planning/scenario_planning/current_max_velocity` | `std_msgs/Float32`                     | 現在の外部速度制限 [m/s]                                                                         |
| `~/closest_velocity`                           | `std_msgs/Float32`                     | エゴ基準座標系に近い計画された速度（デバッグ用）                                                     |
| `~/closest_acceleration`                        | `std_msgs/Float32`                     | エゴ基準座標系に近い計画された加速度（デバッグ用）                                                   |
| `~/closest_jerk`                               | `std_msgs/Float32`                     | エゴ基準座標系に近い計画されたジャーク（デバッグ用）                                                   |
| `~/debug/trajectory_raw`                        | `autoware_planning_msgs/Trajectory`   | 抽出された軌跡（デバッグ用）                                                                            |
| `~/debug/trajectory_external_velocity_limited`   | `autoware_planning_msgs/Trajectory`   | 外部速度制限の軌跡（デバッグ用）                                                                        |
| `~/debug/trajectory_lateral_acc_filtered`       | `autoware_planning_msgs/Trajectory`   | 横加速度制限の軌跡（デバッグ用）                                                                      |
| `~/debug/trajectory_steering_rate_limited`      | `autoware_planning_msgs/Trajectory`   | ステアリング角速度制限の軌跡（デバッグ用）                                                            |
| `~/debug/trajectory_time_resampled`             | `autoware_planning_msgs/Trajectory`   | 時間再サンプリングされた軌跡（デバッグ用）                                                               |
| `~/distance_to_stopline`                        | `std_msgs/Float32`                     | 自車位置からの停止線までの距離（最大50m）（デバッグ用）                                               |
| `~/stop_speed_exceeded`                         | `std_msgs/Bool`                      | 最大速度がゼロのポイントにおける計画速度が閾値を超えると `true` を発行                               |

## パラメータ

### 制約パラメータ

| 名前           | 型     | 説明                                    | デフォルト値 |
| :------------- | :------- | :--------------------------------------------- | :------------ |
| `max_velocity` | `double` | 最大速度制限 [m/s]                       | 20.0          |
| `max_accel`    | `double` | 最大加速度制限 [m/ss]                  | 1.0           |
| `min_decel`    | `double` | 最小減速度制限 [m/ss]                  | -0.5          |
| `stop_decel`   | `double` | 停止位置での停止減速度値 [m/ss] | 0.0           |
| `max_jerk`     | `double` | 最大ジャーク制限 [m/sss]                         | 1.0           |
| `min_jerk`     | `double` | 最小ジャーク制限 [m/sss]                         | -0.5          |

### 外部速度制限パラメータ

| 名前                                       | 型     | 説明                                                 | デフォルト値 |
| :----------------------------------------- | :------- | :------------------------------------------------------ | :------------ |
| `margin_to_insert_external_velocity_limit` | `double` | 外部の速度制限を挿入するマージン距離 [m] | 0.3           |

### カーブパラメータ

| 名前                                   | 型     | 説明                                                                                                                                                                                                  | デフォルト値 |
| :------------------------------------- | :------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------ |
| `enable_lateral_acc_limit`             | `bool`   | Lateral Acceleration フィルタをオン/オフするため。ランタイム時に動的に切り替えることができる。                                                                                                    | true          |
| `max_lateral_accel`                    | `double` | 最大横加速度限度 [m/ss]                                                                                                                                                                        | 0.5           |
| `min_curve_velocity`                   | `double` | 横加速度限度における最小速度 [m/ss]                                                                                                                                                            | 2.74          |
| `decel_distance_before_curve`          | `double` | 横加速度限度のためにカーブ手前で減速する距離 [m]                                                                                                                                       | 3.5           |
| `decel_distance_after_curve`           | `double` | 横加速度限度のためにカーブ後に減速する距離 [m]                                                                                                                                        | 2.0           |
| `min_decel_for_lateral_acc_lim_filter` | `double` | 横加速度フィルタによる急ブレーキを避けるために減速を制限 [m/ss]。強い制限は、障害物回避などによる急カーブの出現に対する減速応答を劣化させる。 | -2.5          |

### Engage および Replan のパラメーター

| 名前                           | 型     | 説明                                                                                                                                            | デフォルト値 |
| :----------------------------- | :------- | :------------------------------------------------------------------------------------------------------------------------------------------------- | :------------ |
| `replan_vel_deviation`         | `double` | 再計画初期速度の速度偏差 [m/s]                                                                                                                | 5.53          |
| `engage_velocity`              | `double` | エンゲージ速度しきい値 [m/s] (軌道速度がこの値より高い場合、この速度を車両速度エンゲージに使用)                                       | 0.25          |
| `engage_acceleration`          | `double` | エンゲージ加速度 [m/ss] (エンゲージ中にこの加速度を使用)                                                                                     | 0.1           |
| `engage_exit_ratio`            | `double` | velocity が engage_exit_ratio x engage_velocity を超えた場合、エンゲージシーケンスから通常の速度プランニングに切り替える。 | 0.5           |
| `stop_dist_to_prohibit_engage` | `double` | 停止点がこの距離内にある場合、速度は 0 に設定され、車両が移動しないようにする [m]                                                                 | 0.5           |

### 停止速度パラメータ

| 名前                | 型     | 説明                                                                           | デフォルト値 |
| :------------------ | :------- | :------------------------------------------------------------------------------------ | :------------ |
| `stopping_velocity` | `double` | 速度が0になる前に、ターゲット速度をこの値に変更する [m/s]                           | 2.778         |
| `stopping_distance` | `double` | `stopping_velocity` の距離 [m]。0 の場合、`stopping_velocity` は適用されません。 | 0.0           |

### 抽出パラメーター

| 名前                    | タイプ     | 説明                                                           | 初期値 |
| :---------------------- | :--------- | :------------------------------------------------------------- | :-------- |
| `extract_ahead_dist`   | `double`   | Planningで使用する前方軌跡距離 [m] | 200.0 |
| `extract_behind_dist`  | `double`   | Planningで使用する後方軌跡距離 [m] | 5.0 |
| `delta_yaw_threshold`  | `double`   | 自車位置と軌跡位置の許可されるYaw角差 [radian] | 1.0472 |

### 再サンプリングパラメータ

| 名前                           | 型     | 説明                                            | 既定値 |
| :----------------------------- | :------- | :----------------------------------------------------- | :------------ |
| `max_trajectory_length`        | `double` | 再サンプリングの最大軌跡長 [m]               | 200.0         |
| `min_trajectory_length`        | `double` | 再サンプリングの最小軌跡長 [m]               | 30.0          |
| `resample_time`                | `double` | 再サンプリングの合計時間 [s]                                | 10.0          |
| `dense_dt`                     | `double` | 高密再サンプリングの再サンプリング間隔時間 [s]          | 0.1           |
| `dense_min_interval_distance`  | `double` | 高密再サンプリングの最小ポイント間隔距離 [m]  | 0.1           |
| `sparse_dt`                    | `double` | 疎再サンプリングの再サンプリング間隔時間 [s]         | 0.5           |
| `sparse_min_interval_distance` | `double` | 疎再サンプリングの最小ポイント間隔距離 [m] | 4.0           |

### 'post resampling'のための再サンプリングパラメーター

| 名称                                 | 種類     | 説明                                                 | デフォルト値 |
| :------------------------------------ | :------- | :---------------------------------------------------- | :------------ |
| `post_max_trajectory_length`          | `double` | 再サンプリング用の軌道の最大長 [m]                  | 300.0         |
| `post_min_trajectory_length`          | `double` | 再サンプリング用の軌道の最小長 [m]                  | 30.0          |
| `post_resample_time`                  | `double` | 高密度サンプリング用の再サンプリング総時間 [s]      | 10.0          |
| `post_dense_dt`                       | `double` | 高密度サンプリング用の再サンプリング時間間隔 [s]     | 0.1           |
| `post_dense_min_interval_distance`    | `double` | 高密度サンプリング用の最小ポイント間隔長 [m]      | 0.1           |
| `post_sparse_dt`                      | `double` | 希薄サンプリング用の再サンプリング時間間隔 [s]      | 0.1           |
| `post_sparse_min_interval_distance`   | `double` | 希薄サンプリング用の最小ポイント間隔長 [m]        | 1.0           |

### ステアリング角速度制限パラメータ

- `estimation.angle_rate_limiter.enabled` (bool): Steering angle rate limiterの有効化/無効化
- `estimation.angle_rate_limiter.max_angle_rate` (double): 制限する最大のステアリング角速度 [rad/s]

| 名称                             | タイプ     | 説明                                                                             | デフォルト値 |
| :------------------------------- | :------- | :------------------------------------------------------------------------------------ | :------------ |
| `enable_steering_rate_limit`     | `bool`   | ステアリングレートフィルターのオン/オフを切り替えます。ランタイム時に動的に切り替えることができます。 | true          |
| `max_steering_angle_rate`        | `double` | 最大操舵角速度 [度/秒]                                                            | 40.0          |
| `resample_ds`                    | `double` | 軌跡点間の距離 [m]                                                               | 0.1           |
| `curvature_threshold`            | `double` | 曲率 > 曲率閾値の場合、ステアリングレートリミットがトリガされます [1/m]                  | 0.02          |
| `curvature_calculation_distance` | `double` | 曲率を計算する際のポイント間の距離 [m]                                             | 1.0           |

### 最適化用の重み

#### JerkFiltered

| 名前            | 型     | 説明                           | デフォルト値 |
| :-------------- | :------- | :------------------------------------ | :------------ |
| `jerk_weight`   | `double` | ジャークの「滑らかさ」コストの重み | 10.0          |
| `over_v_weight` | `double` | 速度制限超過のコストの重み    | 100000.0      |
| `over_a_weight` | `double` | 加速度制限超過のコストの重み    | 5000.0        |
| `over_j_weight` | `double` | ジャーク制限超過のコストの重み     | 1000.0        |

#### レベル2

- **Definition**: ドライバは依然としてコントローラーの操作を行い、他の操作も大部分を担うが、自動化システムが特定の運転タスク（例：車線内走行）を支援する。

**Key Features**:
- 高度のセンシングシステム
- 制御機能（例：サステナビリティやハンドル操作）
- 車線維持アシスト
- 自動緊急ブレーキ

| 名称                  | タイプ   | 説明                                                       | 初期値 |
| :------------------- | :------- | :------------------------------------------------------ | :------------ |
| `pseudo_jerk_weight` | `double` | 「滑らかさ」コストの重み                                     | 100.0         |
| `over_v_weight`      | `double` | 「速度制限超過」コストの重み                                 | 100000.0      |
| `over_a_weight`      | `double` | 「加速度制限超過」コストの重み                                | 1000.0        |

#### Linf

| 名前 | タイプ | 説明 | デフォルト値 |
|---|---|---|---|
| `pseudo_jerk_weight` | `double` | 「滑らかさ」コストの重み | 100.0 |
| `over_v_weight` | `double` | 「速度制限超過」コストの重み | 100000.0 |
| `over_a_weight` | `double` | 「加速度制限超過」コストの重み | 1000.0 |

### その他

| 名前                          | 型     | 説明                                                                                               | デフォルト値 |
| :---------------------------- | :------- | :---------------------------------------------------------------------------------------------------| :------------ |
| `over_stop_velocity_warn_thr` | `double` | 停止点での最適化速度が入力速度を超過していると判断するためのしきい値 [m/s] | 1.389         |

## 想定事項 / 制限事項

- 速度制限または停止点が基準軌道の適切な位置に設定されていることを想定する
- 基準経路内で設定された速度制限が、減速度とジャークの指定された制約により達成できない場合は、速度、加速度、ジャークの逸脱を抑えられる範囲で、抑制を行い減速する
- 逸脱の重要度は設定ファイルで設定する

## （省略可）エラー検出および処理

## （省略可）性能特性

## （省略可）参考文献 / 外部リンク

[1] B. Stellato, et al., "OSQP: an operator splitting solver for quadratic programs", Mathematical Programming Computation, 2020, [10.1007/s12532-020-00179-2](https://link.springer.com/article/10.1007/s12532-020-00179-2).

[2] Y. Zhang, et al., "Toward a More Complete, Flexible, and Safer Speed Planning for Autonomous Driving via Convex Optimization", Sensors, vol. 18, no. 7, p. 2185, 2018, [10.3390/s18072185](https://doi.org/10.3390/s18072185)

## （省略可）将来の拡張 / 未実装部分

