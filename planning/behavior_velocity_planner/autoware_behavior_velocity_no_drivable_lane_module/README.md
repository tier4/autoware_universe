## 走行可能な車線がなし

### 役割

このモジュールは、走行可能な車線を参照していない場合に、パスに関連する部分の速度を計画します。

走行可能な車線とは、運用設計ドメイン(ODD)の対象外である車線または車線以上のことであり、車両は**自**動この車線で運転してはいけません。

車線が走行不能(ODDの対象外)になる理由は、SWやHWの技術的限界、業務上の要件、安全上の考慮事項、さらにはそれらの組み合わせなど、さまざまです。

走行不能な車線の例を次に示します。

- 建設作業などにより意図的に閉鎖された道路
- 安全上の理由から鉄道路線の真下を通るアンダーパスの道路
- 技術的な制限により車両が自**動的に**運転できない勾配の道路
- その他多数の例

![no-drivable-lane-design.svg](./docs/no_drivable_lane_design.svg)

車線は、マップファイル`<tag k="no_drivable_lane" v="yes"/>` に関連する車線に新しいタグを追加することで無効になります。

このモジュールの目標は、車両が走行不能な車線に入る前に停止させること(構成可能な停止マージンを使用)、または走行不能な車線内で自動モードが開始された場合に車両を停止させることです。次に、人間の運転手に運転操作の責任を取ってもらうよう求めます(テイクオーバーリクエスト/介入リクエスト)。

### アクティベーションタイミング

この機能は、ターゲットパスの車線 ID に走行不能な車線のラベル(つまり`no_drivable_lane` 属性が`yes` )がある場合にアクティブになります。

### モジュールパラメータ

| Parameter          | 型     | 説明                                               |
| ------------------ | ------ | -------------------------------------------------- |
| `stop_margin`      | double | 自車位置が速度抑制帯前で停止するためのマージン [m] |
| `print_debug_info` | bool   | デバッグ情報を印刷するかどうか                     |

### 仕組み / アルゴリズム

- lanelet2 マップから経路上の no_drivable_lane 属性を取得
- no_drivable_lane ステートマシンは `INIT` ステートから開始
- 経路と no_drivable_lane ポリゴンの交点を取得
- 次の場合に、no_drivable_lane に対して `APPROACHING` ステートを割り当て:
  - 自車の前から自車の経路と no_drivable_lane ポリゴンの最初の交点までの距離が `stop_margin` より大きい
- 次の場合に、`INSIDE_NO_DRIVABLE_LANE` ステートを割り当て:
  - 自車の経路の最初の点が no_drivable_lane ポリゴン内にある場合、または
  - 自車の前から自車の経路と no_drivable_lane ポリゴンの最初の交点までの距離が `stop_margin` より小さい場合
- 車両が完全に停止したときに、`STOPPED` ステートを割り当て

![no_drivable_lane_scenarios.svg](./docs/no_drivable_lane_scenarios.svg)

### 今後の課題

- [Request to Intervene API](https://github.com/autowarefoundation/autoware/issues/3487) はまだ実装されていないため、この機能は `no_drivable_lane` により車両が停止した後、運転作業の引き継ぎをドライバーに通知するために処理されます
- 車両が no_drivable_lane の前で停止するが、その一部が no_drivable_lane ポリゴンと交差するケースを処理
