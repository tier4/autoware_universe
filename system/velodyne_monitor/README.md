# velodyne_monitor

## 目的

このノードは、Velodyne LiDAR のステータスを監視します。
ステータスの結果は診断として公開されます。この診断を使用して LiDAR エラーを判定することは避けてください。
詳細な理由については[前提条件/既知の制限事項](#assumptions--known-limits) をお読みください。

## 内部動作 / アルゴリズム

Velodyne LiDAR のステータスは `http://[ip_address]/cgi/{info, settings, status, diag}.json` から取得できます。

異常ステータスと対応する診断ステータスのタイプは次のとおりです。

| 異常状態                                             | 診断ステータス |
| ---------------------------------------------------- | -------------- |
| 異常なし                                             | OK             |
| 基板の上面の温度が低すぎる                           | ERROR          |
| 基板の上面の温度が低い                               | WARN           |
| 基板の上面の温度が高すぎる                           | ERROR          |
| 基板の上面の温度が高い                               | WARN           |
| 基板の下面の温度が低すぎる                           | ERROR          |
| 基板の下面の温度が低い                               | WARN           |
| 基板の下面の温度が高すぎる                           | ERROR          |
| 基板の下面の温度が高い                               | WARN           |
| モーターの回転数（rpm）が低すぎる                    | ERROR          |
| モーターの回転数（rpm）が低い                        | WARN           |
| 接続エラー（Velodyne LiDARステータスを取得できない） | ERROR          |

## 入力 / 出力

### 入力

なし

### 出力

| Name           | Type                              | 説明     |
| -------------- | --------------------------------- | -------- |
| `/diagnostics` | `diagnostic_msgs/DiagnosticArray` | 診断出力 |

## パラメータ

### ノードパラメータ

| 名前      | 型     | デフォルト値 | 説明                                                                          |
| --------- | ------ | ------------ | ----------------------------------------------------------------------------- |
| `timeout` | double | 0.5          | Velodyne LiDAR のステータスを取得するための HTTP リクエストのタイムアウト [s] |

### 主要パラメータ

| 名前              | 型     | デフォルト値    | 説明                                                                                                         |
| ----------------- | ------ | --------------- | ------------------------------------------------------------------------------------------------------------ |
| `ip_address`      | 文字列 | "192.168.1.201" | ターゲット Velodyne LiDAR の IP アドレス                                                                     |
| `temp_cold_warn`  | double | -5.0            | Velodyne LiDAR の温度がこの値を下回ると、診断ステータスが WARN になります [°C]                               |
| `temp_cold_error` | double | -10.0           | Velodyne LiDAR の温度がこの値を下回ると、診断ステータスが ERROR になります [°C]                              |
| `temp_hot_warn`   | double | 75.0            | Velodyne LiDAR の温度がこの値を超えると、診断ステータスが WARN になります [°C]                               |
| `temp_hot_error`  | double | 80.0            | Velodyne LiDAR の温度がこの値を超えると、診断ステータスが ERROR になります [°C]                              |
| `rpm_ratio_warn`  | double | 0.80            | モーターの回転数率（= 現在の回転数 / デフォルト回転数）がこの値を下回ると、診断ステータスが WARN になります  |
| `rpm_ratio_error` | double | 0.70            | モーターの回転数率（= 現在の回転数 / デフォルト回転数）がこの値を下回ると、診断ステータスが ERROR になります |

### 設定ファイル

いくつかの Velodyne モデルの設定ファイルは準備されています。
`temp_***` パラメータは各データシートの動作温度を基準に設定されています。
さらに、各モデルの `temp_hot_***` は動作温度より 20 高く設定されています。
現在、`VLP-16.param.yaml` が最も低い仕様であるためデフォルト引数として使用されています。

| モデル名       | 設定名                    | 実稼働温度 [℃] |
| -------------- | ------------------------- | -------------- |
| VLP-16         | VLP-16.param.yaml         | -10 ～ 60      |
| VLP-32C        | VLP-32C.param.yaml        | -20 ～ 60      |
| VLS-128        | VLS-128.param.yaml        | -20 ～ 60      |
| Velarray M1600 | Velarray_M1600.param.yaml | -40 ～ 85      |
| HDL-32E        | HDL-32E.param.yaml        | -10 ～ 60      |

## 前提 / 制限事項

このノードは[http_client](https://github.com/microsoft/cpprestsdk)を使用し、結果をGETメソッドで要求します。このノードは結果を取得するのに数秒かかります。GETリクエストが成功しない場合はタイムアウト例外を生成します。これは頻繁に発生し、診断アグリゲータが出力を古くしたと判断します。そのため、この結果をレーザスキャナのエラーを判断するために使用しなくなり、レーザスキャナのステータスを確認するためにのみ監視することをお勧めします。
