# velodyne_monitor

## 目的

このノードはVelodyne LiDARのステータスを監視します。
ステータスの結果は診断として公開されます。
この診断を使用してLiDARエラーを判断しないように注意してください。
詳細な理由については「前提条件/既知の制限事項」をお読みください。

## 内部処理/アルゴリズム

Velodyne LiDARのステータスは`http://[ip_address]/cgi/{info, settings, status, diag}.json`から取得できます。

異常ステータスの種類とその対応する診断ステータスを以下に示します。

| 異常状態                                     | 診断状態 |
| --------------------------------------------------- | ----------------- |
| 異常なし                                      | OK                |
| トップボードの温度が非常に低い                   | ERROR             |
| トップボードの温度が低い                       | WARN              |
| トップボードの温度が非常に高い                    | ERROR             |
| トップボードの温度が高い                        | WARN              |
| ボトムボードの温度が非常に低い                | ERROR             |
| ボトムボードの温度が低い                    | WARN              |
| ボトムボードの温度が非常に高い                 | ERROR             |
| ボトムボードの温度が高い                     | WARN              |
| モーターのRPM（回転数）が非常に低い   | ERROR             |
| モーターのRPM（回転数）が低い       | WARN              |
| ベロダインLiDARの接続エラー                  | ERROR             |

## 入出力

### 入力

なし

### 出力

| 名前            | 型                               | 説明            |
| --------------- | ----------------------------------- | --------------- |
| `/diagnostics` | `diagnostic_msgs/DiagnosticArray` | 診断結果出力 |

## パラメータ

### ノードパラメータ

| 名称      | 型   | デフォルト値 | 説明                                               |
| --------- | ------ | ------------- | --------------------------------------------------------- |
| `timeout` | double | 0.5           | Velodyne LiDARステータスの取得のためのHTTPリクエストに対するタイムアウト [秒] |

### コアパラメータ

| 名前              | 種類   | デフォルト値   | 説明                                                                                                               |
| ----------------- | ------ | --------------- | ------------------------------------------------------------------------------------------------------------------------- |
| `ip_address`      | 文字列 | "192.168.1.201" | ターゲットVelodyne LiDARのIPアドレス                                                                                  |
| `temp_cold_warn`  | double | -5.0            | Velodyne LiDARの温度がこの値より低い場合、診断ステータスがWARNになります [°C]                                |
| `temp_cold_error` | double | -10.0           | Velodyne LiDARの温度がこの値より低い場合、診断ステータスがERRORになります [°C]                               |
| `temp_hot_warn`   | double | 75.0            | Velodyne LiDARの温度がこの値より高い場合、診断ステータスがWARNになります [°C]                                |
| `temp_hot_error`  | double | 80.0            | Velodyne LiDARの温度がこの値より高い場合、診断ステータスがERRORになります [°C]                               |
| `rpm_ratio_warn`  | double | 0.80            | モーターのrpmレート（=現在のrpm/デフォルトrpm）がこの値より低い場合、診断ステータスがWARNになります  |
| `rpm_ratio_error` | double | 0.70            | モーターのrpmレート（=現在のrpm/デフォルトrpm）がこの値より低い場合、診断ステータスがERRORになります |

### 設定ファイル

複数の Velodyne モデルの設定ファイルが用意されています。

`temp_***` パラメータは、各データシートの動作温度を参考として設定されています。
さらに、各モデルの `temp_hot_***` は動作温度から 20 だけ高い値に設定されています。
現在は、`VLP-16.param.yaml` が最も仕様が低いので、デフォルト引数として使用されています。

| モデル名     | コンフィグ名 | 動作温度 (℃) |
| -------------- | ------------------------- | --------------------------- |
| VLP-16         | VLP-16.param.yaml         | -10 から 60                  |
| VLP-32C        | VLP-32C.param.yaml        | -20 から 60                  |
| VLS-128        | VLS-128.param.yaml        | -20 から 60                  |
| Velarray M1600 | Velarray_M1600.param.yaml | -40 から 85                  |
| HDL-32E        | HDL-32E.param.yaml        | -10 から 60                  |

## 想定/既知の制限事項

このノードは [http_client](https://github.com/microsoft/cpprestsdk) を使用し、GET メソッドでリクエスト結果を取得します。
結果を取得するのに数秒かかり、GET リクエストが成功しない場合はタイムアウト例外を生成します。
これは頻繁に発生し、診断アグリゲーターが古くなっていることを出力します。
したがって、この結果をライダエラーの判断に使用することを停止し、ライダのステータスの確認にのみ監視することをお勧めします。

