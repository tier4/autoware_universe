<launch>
  <!-- planning module -->

  <!-- mission planner -->
  <arg name="mission_planner_param_path"/>
  <arg name="launch_remaining_distance_time_calculator" default="false"/>

  <!--
    The /awapi/awapi_awiv_adapter node tries to retrieve the parameter /max_velocity from the /planning/scenario_planning/velocity_smoother node.
    https://github.com/tier4/tier4_ad_api_adaptor/blob/v0.48.0/awapi_awiv_adapter/src/awapi_awiv_adapter_core.cpp#L32-L39

    So without a rule-based planner, the /awapi/awapi_awiv_adapter will wait for the planning node to launch without a timeout.
    And some API topics will not be handled properly. To prevent this, we run the parameter_blackboard as a dummy node here.

    The node and parameter names are defined in the launch file below.
    https://github.com/tier4/tier4_ad_api_adaptor/blob/v0.48.0/awapi_awiv_adapter/launch/awapi_awiv_adapter.launch.xml#L66-L67
  -->
  <node pkg="demo_nodes_cpp" exec="parameter_blackboard" name="velocity_smoother" namespace="/planning/scenario_planning" output="screen">
    <param name="max_velocity" value="16.6"/>
  </node>

  <group>
    <push-ros-namespace namespace="planning"/>
    <!-- mission planning module -->
    <group>
      <push-ros-namespace namespace="mission_planning"/>
      <include file="$(find-pkg-share tier4_planning_launch)/launch/mission_planning/mission_planning.launch.xml">
        <arg name="mission_planner_param_path" value="$(var mission_planner_param_path)"/>
      </include>
    </group>

    <group>
      <!-- trajectory generator -->
      <group>
        <push-ros-namespace namespace="trajectory_generator"/>
        <!-- neural network based planning module -->
        <group>
          <push-ros-namespace namespace="neural_network_based_planner"/>
          <include file="$(find-pkg-share autoware_diffusion_planner)/launch/diffusion_planner.launch.xml">
            <arg name="input_odometry" value="/localization/kinematic_state"/>
            <arg name="input_acceleration" value="/localization/acceleration"/>
            <arg name="input_route" value="/planning/mission_planning/route"/>
            <arg name="input_traffic_signals" value="/perception/traffic_light_recognition/traffic_signals"/>
            <arg name="input_tracked_objects" value="/perception/object_recognition/tracking/objects"/>
            <arg name="input_vector_map" value="/map/vector_map"/>
            <arg name="input_turn_indicators" value="/vehicle/status/turn_indicators_status"/>
            <arg name="output_trajectories" value="/planning/generator/diffusion_planner/candidate_trajectories"/>
            <arg name="output_turn_indicators" value="/planning/turn_indicators_cmd"/>
          </include>
          <include file="$(find-pkg-share autoware_trajectory_modifier)/launch/trajectory_modifier.launch.xml">
            <arg name="input_candidate_trajectories" value="/planning/generator/diffusion_planner/candidate_trajectories"/>
            <arg name="output_candidate_trajectories" value="/planning/generator/diffusion_planner/modified_candidate_trajectories"/>
            <arg name="input_odometry" value="/localization/kinematic_state"/>
            <arg name="input_acceleration" value="/localization/acceleration"/>
          </include>
          <include file="$(find-pkg-share autoware_trajectory_optimizer)/launch/trajectory_optimizer.launch.xml">
            <arg name="input_trajectories" value="/planning/generator/diffusion_planner/modified_candidate_trajectories"/>
            <arg name="output_traj" value="/planning/generator/trajectory_optimizer/debug/trajectory"/>
            <arg name="output_trajectories" value="/planning/generator/trajectory_optimizer/candidate_trajectories"/>
          </include>
        </group>
      </group>

      <!-- trajectory selector -->
      <group>
        <push-ros-namespace namespace="trajectory_selector"/>
        <include file="$(find-pkg-share autoware_trajectory_safety_filter)/launch/trajectory_safety_filter.launch.xml">
          <arg name="input_trajectories" value="/planning/generator/trajectory_optimizer/candidate_trajectories"/>
          <arg name="output_trajectories" value="/planning/trajectory_selector/safety_filter/candidate_trajectories"/>
          <arg name="input_vector_map" value="/map/vector_map"/>
          <arg name="input_odometry" value="/localization/kinematic_state"/>
          <arg name="input_objects" value="/perception/object_recognition/objects"/>
        </include>
        <include file="$(find-pkg-share autoware_trajectory_traffic_rule_filter)/launch/trajectory_traffic_rule_filter.launch.xml">
          <arg name="input_trajectories" value="/planning/trajectory_selector/safety_filter/candidate_trajectories"/>
          <arg name="output_trajectories" value="/planning/trajectory_selector/traffic_rule_filter/candidate_trajectories"/>
          <arg name="input_map" value="/map/vector_map"/>
          <arg name="input_traffic_signals" value="/perception/traffic_light_recognition/traffic_signals"/>
        </include>
        <include file="$(find-pkg-share autoware_trajectory_ranker)/launch/trajectory_ranker.launch.xml">
          <arg name="input_trajectories" value="/planning/trajectory_selector/traffic_rule_filter/candidate_trajectories"/>
          <arg name="output_trajectories" value="/planning/trajectory_selector/ranker/scored_trajectories"/>
          <arg name="input_route" value="/planning/mission_planning/route"/>
          <arg name="input_vector_map" value="/map/vector_map"/>
          <arg name="input_odometry" value="/localization/kinematic_state"/>
          <arg name="input_objects" value="/perception/object_recognition/objects"/>
        </include>
        <include file="$(find-pkg-share autoware_trajectory_adapter)/launch/trajectory_adapter.launch.xml">
          <arg name="input_trajectories" value="/planning/trajectory_selector/ranker/scored_trajectories"/>
          <arg name="output_trajectory" value="/planning/trajectory"/>
        </include>
      </group>
    </group>

    <!-- mission remaining distance and time calculator -->
    <group if="$(var launch_remaining_distance_time_calculator)">
      <include file="$(find-pkg-share autoware_remaining_distance_time_calculator)/launch/remaining_distance_time_calculator.launch.xml"/>
    </group>
  </group>
</launch>
