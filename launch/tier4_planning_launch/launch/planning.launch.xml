<launch>
  <!-- planning module -->

  <!-- mission planner -->
  <arg name="mission_planner_param_path"/>
  <!-- parking -->
  <arg name="freespace_planner_param_path"/>
  <!-- planning validator -->
  <arg name="planning_validator_param_path"/>
  <arg name="planning_validator_latency_checker_param_path"/>
  <arg name="planning_validator_trajectory_checker_param_path"/>
  <arg name="planning_validator_intersection_collision_checker_param_path"/>
  <arg name="planning_validator_rear_collision_checker_param_path"/>
  <!-- Auto mode setting-->
  <arg name="enable_all_modules_auto_mode"/>
  <arg name="is_simulation"/>
  <arg name="launch_remaining_distance_time_calculator" default="false"/>
  <!-- Input topic parameters -->
  <arg name="input_objects_topic_name"/>
  <arg name="input_pointcloud_topic_name"/>

  <!-- planning architecture -->
  <arg name="use_neural_network_planner" default="true"/>

  <group if="$(var use_neural_network_planner)">
    <!--
      The /awapi/awapi_awiv_adapter node tries to retrieve the parameter /max_velocity from the /planning/scenario_planning/velocity_smoother node.
      https://github.com/tier4/tier4_ad_api_adaptor/blob/v0.48.0/awapi_awiv_adapter/src/awapi_awiv_adapter_core.cpp#L32-L39

      So without a rule-based planner, the /awapi/awapi_awiv_adapter will wait for the planning node to launch without a timeout.
      And some API topics will not be handled properly. To prevent this, we run the parameter_blackboard as a dummy node here.

      The node and parameter names are defined in the launch file below.
      https://github.com/tier4/tier4_ad_api_adaptor/blob/v0.48.0/awapi_awiv_adapter/launch/awapi_awiv_adapter.launch.xml#L66-L67
    -->
    <node pkg="demo_nodes_cpp" exec="parameter_blackboard" name="velocity_smoother" namespace="/planning/scenario_planning" output="screen">
      <param name="max_velocity" value="16.6"/>
    </node>
  </group>

  <group>
    <push-ros-namespace namespace="planning"/>

    <!-- manual lane change handler module -->
    <group unless="$(var use_neural_network_planner)">
      <push-ros-namespace namespace="mission_planning"/>
      <include file="$(find-pkg-share autoware_manual_lane_change_handler)/launch/manual_lane_change_handler.launch.xml">
        <arg name="mission_planner_param_path" value="$(var mission_planner_param_path)"/>
      </include>
    </group>

    <!-- mission planning module -->
    <group>
      <push-ros-namespace namespace="mission_planning"/>
      <include file="$(find-pkg-share tier4_planning_launch)/launch/mission_planning/mission_planning.launch.xml">
        <arg name="mission_planner_param_path" value="$(var mission_planner_param_path)"/>
      </include>
    </group>

    <!-- neural network planning module -->
    <group if="$(var use_neural_network_planner)">
      <include file="$(find-pkg-share tier4_planning_launch)/launch/neural_network_planning/neural_network_planner.launch.xml"/>
    </group>

    <!-- scenario planning module -->
    <group unless="$(var use_neural_network_planner)">
      <push-ros-namespace namespace="scenario_planning"/>
      <include file="$(find-pkg-share tier4_planning_launch)/launch/scenario_planning/scenario_planning.launch.xml">
        <arg name="enable_all_modules_auto_mode" value="$(var enable_all_modules_auto_mode)"/>
        <arg name="is_simulation" value="$(var is_simulation)"/>
        <arg name="input_objects_topic_name" value="$(var input_objects_topic_name)"/>
        <arg name="input_pointcloud_topic_name" value="$(var input_pointcloud_topic_name)"/>
      </include>
    </group>

    <!-- planning validator -->
    <group unless="$(var use_neural_network_planner)">
      <include file="$(find-pkg-share autoware_planning_validator)/launch/planning_validator.launch.xml">
        <arg name="container_type" value="component_container_mt"/>
        <arg name="input_trajectory_name" value="/planning/scenario_planning/velocity_smoother/trajectory"/>
        <arg name="output_trajectory" value="/planning/trajectory"/>
        <arg name="input_objects_topic_name" value="$(var input_objects_topic_name)"/>
        <arg name="input_pointcloud_topic_name" value="$(var input_pointcloud_topic_name)"/>
        <arg name="planning_validator_param_path" value="$(var planning_validator_param_path)"/>
        <arg name="planning_validator_latency_checker_param_path" value="$(var planning_validator_latency_checker_param_path)"/>
        <arg name="planning_validator_trajectory_checker_param_path" value="$(var planning_validator_trajectory_checker_param_path)"/>
        <arg name="planning_validator_intersection_collision_checker_param_path" value="$(var planning_validator_intersection_collision_checker_param_path)"/>
        <arg name="planning_validator_rear_collision_checker_param_path" value="$(var planning_validator_rear_collision_checker_param_path)"/>
      </include>
    </group>

    <!-- planning evaluator -->
    <group unless="$(var use_neural_network_planner)">
      <include file="$(find-pkg-share autoware_planning_evaluator)/launch/planning_evaluator.launch.xml">
        <arg name="input_objects_topic_name" value="$(var input_objects_topic_name)"/>
      </include>
    </group>

    <!-- mission remaining distance and time calculator -->
    <group if="$(var launch_remaining_distance_time_calculator)">
      <include file="$(find-pkg-share autoware_remaining_distance_time_calculator)/launch/remaining_distance_time_calculator.launch.xml"/>
    </group>
  </group>
</launch>
