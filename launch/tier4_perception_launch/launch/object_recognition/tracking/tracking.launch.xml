<?xml version="1.0"?>
<launch>
  <!-- Current namespace -->
  <let name="ns" value="/perception/object_recognition/tracking"/>

  <!-- Radar Tracking and Merger parameters -->
  <arg name="object_recognition_tracking_radar_object_tracker_data_association_matrix_param_path" description="association param file for radar far object tracking"/>
  <arg name="object_recognition_tracking_radar_object_tracker_tracking_setting_param_path" description="tracking setting param file for radar far object tracking"/>
  <arg name="object_recognition_tracking_radar_object_tracker_node_param_path" description="node param file for radar far object tracking"/>
  <arg name="object_recognition_tracking_object_merger_data_association_matrix_param_path" description="association param file for radar and lidar object merger"/>
  <arg name="object_recognition_tracking_object_merger_node_param_path" description="node param file for radar and lidar object merger"/>

  <!-- V2i Tracking and Merger parameters -->
  <!-- <arg name="object_recognition_tracking_v2i_object_tracker_data_association_matrix_param_path" description="association param file for v2i far object tracking"/>
  <arg name="object_recognition_tracking_v2i_object_tracker_tracking_setting_param_path" description="tracking setting param file for v2i far object tracking"/>
  <arg name="object_recognition_tracking_v2i_object_tracker_node_param_path" description="node param file for v2i far object tracking"/> -->
  <arg name="object_recognition_tracking_v2i_tracked_object_sorter_param_path" description="param file for v2i distance and velocity filters"/>
  <arg name="object_recognition_tracking_v2i_tracked_object_lanelet_filter_param_path" description="param file for v2i lanelet filter"/>
  <arg name="object_recognition_tracking_v2i_merger_data_association_matrix_param_path" description="association param file for v2i and lidar object merger"/>
  <arg name="object_recognition_tracking_v2i_merger_node_param_path" description="node param file for v2i and lidar object merger"/>
  
  <!-- Pipeline junctions -->
  <arg name="mode" default="lidar" description="options: `camera_lidar_radar_fusion`, `camera_lidar_fusion`, `lidar_radar_fusion`, `lidar` or `radar`"/>
  <arg name="use_radar_tracking_fusion" default="false" description="use radar tracking fusion"/>
  <let name="use_radar_tracking_fusion" value="false" if="$(eval '&quot;$(var mode)&quot;!=&quot;camera_lidar_radar_fusion&quot;')"/>
  <arg name="use_v2i_tracking_fusion" default="false" description="use v2i tracking fusion"/>
  <arg name="use_multi_channel_tracker_merger"/>
  <arg name="use_validator" description="use obstacle_pointcloud based validator"/>

  <!-- External interface -->
  <arg name="lidar_detection_model_type" default="centerpoint"/>
  <arg name="input/merged_detection/channel" default="detected_objects"/>
  <arg name="input/merged_detection/objects" default="/perception/object_recognition/detection/objects"/>
  <arg name="input/lidar_dnn/channel" default="lidar_$(var lidar_detection_model_type)"/>
  <arg name="input/lidar_dnn/objects" default="/perception/object_recognition/detection/$(var lidar_detection_model_type)/objects"/>
  <arg name="input/lidar_dnn_validated/objects" default="/perception/object_recognition/detection/$(var lidar_detection_model_type)/validation/objects"/>
  <arg name="input/camera_lidar_rule_detector/channel" default="camera_lidar_fusion"/>
  <arg name="input/camera_lidar_rule_detector/objects" default="/perception/object_recognition/detection/clustering/camera_lidar_fusion/objects"/>
  <arg name="input/tracker_based_detector/channel" default="detection_by_tracker"/>
  <arg name="input/tracker_based_detector/objects" default="/perception/object_recognition/detection/detection_by_tracker/objects"/>
  <arg name="input/radar/channel" default="radar"/>
  <arg name="input/radar/far_objects" default="/perception/object_recognition/detection/radar/far_objects"/>
  <arg name="input/radar/objects" default="/perception/object_recognition/detection/radar/objects"/>
  <arg name="input/v2i/far_objects" default="/v2i/smartpole"/>

  <arg name="output/objects_" default="$(var ns)/objects"/>


  <group unless="$(var use_multi_channel_tracker_merger)">
    <!-- Internal interface -->
    <!-- radar common -->
    <let name="radar_tracker/input/objects" value="$(var input/radar/far_objects)"/>
    <let name="radar_tracker/output/objects" value="$(var ns)/radar/far_objects"/>

    <!-- v2i common -->

    <let name="v2i_tracked_object_sorter/input/objects" value="$(var input/v2i/far_objects)"/>
    <let name="v2i_tracked_object_sorter/output/objects" value="$(var ns)/v2i/sorted_tracked_objects"/>

    <let name="v2i_tracked_object_lanelet_filter/input/object" value="$(var v2i_tracked_object_sorter/output/objects)"/>
    <let name="v2i_tracked_object_lanelet_filter/output/object" value="$(var ns)/v2i/filtered_tracked_objects"/>
    


    <!-- none -->
    <!-- <let name="multi_object_tracker/output/objects" value="$(var output/objects)" if="$(eval &quot;'$(var use_radar_tracking_fusion)'=='false' and '$(var use_v2i_tracking_fusion)'=='false'&quot;)"/> -->


    <let name="multi_object_tracker/output/objects" value="$(var ns)/near_objects" />
    <!-- <let name="multi_object_tracker/output/objects" value="$(var output/objects)" /> -->

    
    <!-- Multi object tracking -->
    <include file="$(find-pkg-share autoware_multi_object_tracker)/launch/multi_object_tracker.launch.xml">
      <arg name="input/detection01/objects" value="$(var input/merged_detection/objects)"/>
      <arg name="input/detection01/channel" value="$(var input/merged_detection/channel)"/>
      <arg name="output/objects" value="$(var multi_object_tracker/output/objects)"/>
      <arg name="data_association_matrix_path" value="$(var object_recognition_tracking_multi_object_tracker_data_association_matrix_param_path)"/>
      <arg name="input_channels_path" value="$(var object_recognition_tracking_multi_object_tracker_input_channels_param_path)"/>
      <arg name="tracker_setting_path" value="$(var object_recognition_tracking_multi_object_tracker_node_param_path)"/>
    </include>

    <!-- Run with tracking merger to add far radar information -->
    <group if="$(var use_radar_tracking_fusion)">

      <let name="tracker_merger/input/main_objects" value="$(var multi_object_tracker/output/objects)" />
      <let name="tracker_merger/input/sub_objects" value="$(var radar_tracker/output/objects)" />
      <let name="tracker_merger/output/objects" value="$(var ns)/camera_lidar_radar_objects" if="$(var use_v2i_tracking_fusion)"/>
      <let name="tracker_merger/output/objects" value="$(var output/objects_)" unless="$(var use_v2i_tracking_fusion)"/>


      <!-- radar long range dynamic object tracking -->
      <include file="$(find-pkg-share autoware_radar_object_tracker)/launch/radar_object_tracker.launch.xml">
        <arg name="input" value="$(var radar_tracker/input/objects)"/>
        <arg name="output" value="$(var radar_tracker/output/objects)"/>
        <arg name="data_association_matrix_path" value="$(var object_recognition_tracking_radar_object_tracker_data_association_matrix_param_path)"/>
        <arg name="tracker_setting_path" value="$(var object_recognition_tracking_radar_object_tracker_tracking_setting_param_path)"/>
        <arg name="radar_object_tracker_param_path" value="$(var object_recognition_tracking_radar_object_tracker_node_param_path)"/>
      </include>

      <!-- tracking object merger to merge near objects and far objects -->
      <include file="$(find-pkg-share autoware_tracking_object_merger)/launch/decorative_tracker_merger.launch.xml">
        <arg name="node_name" value="decorative_tracker_merger"/>
        <arg name="input/main_object" value="$(var tracker_merger/input/main_objects)"/>
        <arg name="input/sub_object" value="$(var tracker_merger/input/sub_objects)"/>
        <arg name="output" value="$(var tracker_merger/output/objects)"/>
        <arg name="data_association_matrix_path" value="$(var object_recognition_tracking_object_merger_data_association_matrix_param_path)"/>
        <arg name="node_param_file_path" value="$(var object_recognition_tracking_object_merger_node_param_path)"/>
      </include>
    </group>

    <!-- Run with tracking merger to add far v2i information -->
    <include file="$(find-pkg-share autoware_object_sorter)/launch/tracked_object_sorter.launch.xml">
      <arg name="input/objects" value="$(var v2i_tracked_object_sorter/input/objects)"/>
      <arg name="output/objects" value="$(var v2i_tracked_object_sorter/output/objects)"/>
      <arg name="param_path" value="$(var object_recognition_tracking_v2i_tracked_object_sorter_param_path)"/>
    </include>

    <include file="$(find-pkg-share autoware_detected_object_validation)/launch/tracked_object_lanelet_filter.launch.xml">
      <arg name="input/object" value="$(var v2i_tracked_object_lanelet_filter/input/object)"/>
      <arg name="output/object" value="$(var v2i_tracked_object_lanelet_filter/output/object)"/>
      <arg name="filtering_range_param" value="$(var object_recognition_tracking_v2i_tracked_object_lanelet_filter_param_path)"/>
    </include>
    <group if="$(var use_v2i_tracking_fusion)">

      <let name="v2i_tracker_merger/input/main_objects" value="$(var ns)/camera_lidar_radar_objects" if="$(var use_radar_tracking_fusion)"/>
      <let name="v2i_tracker_merger/input/main_objects" value="$(var multi_object_tracker/output/objects)" unless="$(var use_radar_tracking_fusion)"/>
      <let name="v2i_tracker_merger/input/sub_objects" value="$(var v2i_tracked_object_lanelet_filter/output/object)" if="$(var use_radar_tracking_fusion)"/>
      <let name="v2i_tracker_merger/input/sub_objects" value="$(var v2i_tracker/output/objects)" unless="$(var use_radar_tracking_fusion)"/>
      <let name="v2i_tracker_merger/output/objects" value="$(var output/objects_)"/>
      

      <!-- v2i long range dynamic object tracking -->
      <!-- <include file="$(find-pkg-share autoware_v2i_object_tracker)/launch/v2i_object_tracker.launch.xml">
        <arg name="input" value="$(var v2i_tracker/input/objects)"/>
        <arg name="output" value="$(var v2i_tracker/output/objects)"/>
        <arg name="data_association_matrix_path" value="$(var object_recognition_tracking_v2i_object_tracker_data_association_matrix_param_path)"/>
        <arg name="tracker_setting_path" value="$(var object_recognition_tracking_v2i_object_tracker_tracking_setting_param_path)"/>
        <arg name="radar_object_tracker_param_path" value="$(var object_recognition_tracking_v2i_object_tracker_node_param_path)"/>
      </include> -->

      <!-- <include file="$(find-pkg-share autoware_object_sorter)/launch/tracked_object_sorter.launch.xml">
        <arg name="input/objects" value="$(var v2i_tracked_object_sorter/input/objects)"/>
        <arg name="output/objects" value="$(var v2i_tracked_object_sorter/output/objects)"/>
        <arg name="param_path" value="$(var object_recognition_tracking_v2i_tracked_object_sorter_param_path)"/>
      </include>

      <include file="$(find-pkg-share autoware_detected_object_validation)/launch/tracked_object_lanelet_filter.launch.xml">
        <arg name="input/object" value="$(var v2i_tracked_object_lanelet_filter/input/object)"/>
        <arg name="output/object" value="$(var v2i_tracked_object_lanelet_filter/output/object)"/>
        <arg name="filtering_range_param" value="$(var object_recognition_tracking_v2i_tracked_object_lanelet_filter_param_path)"/>
      </include> -->

      <!-- tracking object merger to merge near objects and far objects -->
      <include file="$(find-pkg-share autoware_tracking_v2i_object_merger)/launch/decorative_tracker_merger.launch.xml">
        <arg name="node_name" value="decorative_v2i_tracker_merger"/>
        <arg name="input/main_object" value="$(var v2i_tracker_merger/input/main_objects)"/>
        <!-- <arg name="input/main_object" value="/v2i/dummy_pub"/> -->
        <arg name="input/sub_object" value="$(var v2i_tracker_merger/input/sub_objects)"/>
        <arg name="output" value="$(var v2i_tracker_merger/output/objects)"/>
        <arg name="data_association_matrix_path" value="$(var object_recognition_tracking_v2i_merger_data_association_matrix_param_path)"/>
        <arg name="node_param_file_path" value="$(var object_recognition_tracking_v2i_merger_node_param_path)"/>
      </include>
    </group>

  </group>
  <!-- Object list for multi-channel tracker merger -->
  <group if="$(var use_multi_channel_tracker_merger)">
    <let name="detection_enabled_channels" value="$(var input/detection_input_channels)"/>
    <let name="lidar_dnn_detection_output" value="$(var lidar_detection_model_type)_validated" if="$(var use_validator)"/>
    <let name="lidar_dnn_detection_output" value="$(var lidar_detection_model_type)" unless="$(var use_validator)"/>
    <group scoped="false" if="$(eval '&quot;$(var mode)&quot;==&quot;camera_lidar_radar_fusion&quot;')">
      <let name="detection_enabled_channels" value="['lidar_$(var lidar_dnn_detection_output)','camera_lidar_fusion','detection_by_tracker','radar_far']" if="$(var use_detection_by_tracker)"/>
      <let name="detection_enabled_channels" value="['lidar_$(var lidar_dnn_detection_output)','camera_lidar_fusion','radar_far']" unless="$(var use_detection_by_tracker)"/>
    </group>
    <group scoped="false" if="$(eval '&quot;$(var mode)&quot;==&quot;camera_lidar_fusion&quot;')">
      <let name="detection_enabled_channels" value="['lidar_$(var lidar_dnn_detection_output)','camera_lidar_fusion','detection_by_tracker']" if="$(var use_detection_by_tracker)"/>
      <let name="detection_enabled_channels" value="['lidar_$(var lidar_dnn_detection_output)','camera_lidar_fusion']" unless="$(var use_detection_by_tracker)"/>
    </group>
    <group scoped="false" if="$(eval '&quot;$(var mode)&quot;==&quot;lidar_radar_fusion&quot;')">
      <let name="detection_enabled_channels" value="['lidar_$(var lidar_dnn_detection_output)','detection_by_tracker','radar_far']" if="$(var use_detection_by_tracker)"/>
      <let name="detection_enabled_channels" value="['lidar_$(var lidar_dnn_detection_output)','radar_far']" unless="$(var use_detection_by_tracker)"/>
    </group>
    <group scoped="false" if="$(eval '&quot;$(var mode)&quot;==&quot;lidar&quot;')">
      <let name="detection_enabled_channels" value="['lidar_$(var lidar_dnn_detection_output)','detection_by_tracker']" if="$(var use_detection_by_tracker)"/>
      <let name="detection_enabled_channels" value="['lidar_$(var lidar_dnn_detection_output)']" unless="$(var use_detection_by_tracker)"/>
    </group>
    <group scoped="false" if="$(eval '&quot;$(var mode)&quot;==&quot;radar&quot;')">
      <let name="detection_enabled_channels" value="['radar_far']"/>
    </group>

    <!-- Multi object tracking -->
    <include file="$(find-pkg-share autoware_multi_object_tracker)/launch/multi_object_tracker.launch.xml">
      <arg name="selected_input_channels" value="$(var detection_enabled_channels)"/>
      <arg name="output" value="$(var output/objects)"/>
      <arg name="data_association_matrix_path" value="$(var object_recognition_tracking_multi_object_tracker_data_association_matrix_param_path)"/>
      <arg name="input_channels_path" value="$(var object_recognition_tracking_multi_object_tracker_input_channels_param_path)"/>
      <arg name="tracker_setting_path" value="$(var object_recognition_tracking_multi_object_tracker_node_param_path)"/>
    </include>
  </group>
</launch>